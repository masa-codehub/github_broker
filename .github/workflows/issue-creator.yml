name: Issue Creator

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  create_issue:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.3' # プロジェクトのPythonバージョンに合わせて調整

      - name: Install dependencies
        run: pip install -e .


      - name: Identify _in_box/ files
        id: identify_files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Identifying _in_box/ files in merged PR..."
          PR_NUMBER=${{ github.event.pull_request.number }}
          # gh CLIを使ってPRのファイルリストを取得
          FILES_JSON=$(gh pr view $PR_NUMBER --json files -q '.files[].path')
          # Pythonスクリプトにファイルリストを渡し、フィルタリングを実行
          FILTERED_FILES=$(python -c "import sys; from github_broker.infrastructure.document_validation.in_box_file_filter import filter_in_box_files; file_list = sys.stdin.read().splitlines(); print('\n'.join(filter_in_box_files(file_list)))" <<< "$FILES_JSON")

          if [ -z "$FILTERED_FILES" ]; then
            echo "No _in_box/ files found in the merged PR."
          else
            echo "Found _in_box/ files:"
            echo "$FILTERED_FILES"
            # 後続のステップで利用するために、出力を設定することも可能
            echo "IN_BOX_FILES<<EOF" >> $GITHUB_OUTPUT
            echo "$FILTERED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Process _in_box/ files and create issues
        if: steps.identify_files.outputs.IN_BOX_FILES != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IN_BOX_FILES: ${{ steps.identify_files.outputs.IN_BOX_FILES }}
        run: |
          python -c "
          import os
          import sys
          import json
          # import subprocess
          from github_broker.infrastructure.document_validation.issue_parser import parse_issue_content

          in_box_files = os.environ.get('IN_BOX_FILES', '').splitlines()
          
          for file_path in in_box_files:
              if not file_path or not os.path.exists(file_path):
                  print(f'Warning: File not found or path is empty: {file_path}', file=sys.stderr)
                  continue

              print(f'Processing file: {file_path}')
              try:
                  with open(file_path, 'r') as f:
                      content = f.read()
              except IOError as e:
                  print(f'Error reading file {file_path}: {e}', file=sys.stderr)
                  continue

              issue_data = parse_issue_content(content)

              if not issue_data:
                  print(f'Failed to parse issue data from {file_path}', file=sys.stderr)
                  continue

              cmd = [
                  'gh', 'issue', 'create',
                  '-t', issue_data.title,
                  '-b', issue_data.body,
                  '--repo', os.environ['GITHUB_REPOSITORY']
              ]
              if issue_data.labels:
                  cmd.extend(['--label', ','.join(issue_data.labels)])
              if issue_data.assignees:
                  cmd.extend(['--assignee', ','.join(issue_data.assignees)])
              
              print(f'Executing: {\' \'.join(cmd)}')
              # result = subprocess.run(cmd, capture_output=True, text=True)
              # if result.returncode != 0:
              #     print(f'Error creating issue for {file_path}: {result.stderr}', file=sys.stderr)
              #     continue
              # issue_url = result.stdout.strip()
              # issue_number = issue_url.split('/')[-1]
              # print(f'Created issue #{issue_number}')
              
              # For testing purposes:
              issue_number = '12345'
              print(f'Dummy Issue Created: #{issue_number}')

              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f'ISSUE_NUMBER={issue_number}\n')
                  f.write(f'ISSUE_TITLE={issue_data.title}\n')
          "
