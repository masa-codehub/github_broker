name: Issue Creator

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  create_issue:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.3' # プロジェクトのPythonバージョンに合わせて調整

      - name: Install dependencies
        run: pip install -e .

      - name: Install yq
        run: sudo snap install yq

      - name: Identify _in_box/ files
        id: identify_files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Identifying _in_box/ files in merged PR..."
          PR_NUMBER=${{ github.event.pull_request.number }}
          # gh CLIを使ってPRのファイルリストを取得
          FILES_JSON=$(gh pr view $PR_NUMBER --json files -q '.files[].path')
          # Pythonスクリプトにファイルリストを渡し、フィルタリングを実行
          FILTERED_FILES=$(python -c "import sys; from github_broker.infrastructure.document_validation.in_box_file_filter import filter_in_box_files; file_list = sys.stdin.read().splitlines(); print('\n'.join(filter_in_box_files(file_list)))" <<< "$FILES_JSON")

          if [ -z "$FILTERED_FILES" ]; then
            echo "No _in_box/ files found in the merged PR."
          else
            echo "Found _in_box/ files:"
            echo "$FILTERED_FILES"
            # 後続のステップで利用するために、出力を設定することも可能
            echo "IN_BOX_FILES<<EOF" >> $GITHUB_OUTPUT
            echo "$FILTERED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Process _in_box/ files and create issues
        if: steps.identify_files.outputs.IN_BOX_FILES != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IN_BOX_FILES: ${{ steps.identify_files.outputs.IN_BOX_FILES }}
        run: |
          echo "Processing _in_box/ files..."
          IFS=$'\n' read -r -d '' -a files <<< "$IN_BOX_FILES"
          
          for file_path in "${files[@]}"; do
            echo "Processing file: $file_path"
            
            # ファイル内容の読み込みとFront Matterの分離
            content=$(cat "$file_path")
            front_matter=$(echo "$content" | yq '. as $item load_str("---\n" + $item + "\n---") | select(has("---")) | . as $doc | $doc["---"]' -)
            body_content=$(echo "$content" | sed '1,/^---$/d; /^---$/d')

            # Front Matterからメタデータを抽出
            title=$(echo "$front_matter" | yq '.title' -)
            labels=$(echo "$front_matter" | yq '.labels[]' - | paste -sd,)
            assignees=$(echo "$front_matter" | yq '.assignees[]' - | paste -sd,)

            echo "Title: $title"
            echo "Labels: $labels"
            echo "Assignees: $assignees"
            echo "Body Content: $body_content"

            # Issueの作成
            # --repoは現在のリポジトリを指す
            # gh issue create -t "$title" -b "$body_content" --label "$labels" --assignee "$assignees" --repo "$GITHUB_REPOSITORY"
            issue_command="gh issue create -t \"$title\" -b \"$body_content\" --repo \"$GITHUB_REPOSITORY\""

            if [ -n "$labels" ]; then
              issue_command+=" --label \"$labels\""
            fi
            if [ -n "$assignees" ]; then
              issue_command+=" --assignee \"$assignees\""
            fi

            echo "Executing: $issue_command"
            
            # 実際にはここでgh issue createを実行する
            # eval "$issue_command"
            # issue_number=$(eval "$issue_command" | grep -o 'https://github.com/.*/issues/[0-9]*' | sed 's#^.*/##')
            # echo "Created issue #$issue_number"

            # テスト用にコマンドを表示し、ダミーのIssue番号を出力
            echo "Dummy Issue Created: #12345"
            echo "ISSUE_NUMBER=12345" >> $GITHUB_ENV
            echo "ISSUE_TITLE=$title" >> $GITHUB_ENV

          done
