name: Issue Creator

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  create_issue:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.3' # プロジェクトのPythonバージョンに合わせて調整

      - name: Configure Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: pip install -e .

      - name: Identify _in_box/ files
        id: identify_files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Identifying _in_box/ files in merged PR..."
          PR_NUMBER=${{ github.event.pull_request.number }}
          # gh CLIを使ってPRのファイルリストを取得
          FILES_JSON=$(gh pr view $PR_NUMBER --json files -q '.files[].path')
          # Pythonスクリプトにファイルリストを渡し、フィルタリングを実行
          FILTERED_FILES=$(python -c "import sys; from github_broker.infrastructure.document_validation.in_box_file_filter import filter_in_box_files; file_list = sys.stdin.read().splitlines(); print('\n'.join(filter_in_box_files(file_list)))" <<< "$FILES_JSON")

          if [ -z "$FILTERED_FILES" ]; then
            echo "No _in_box/ files found in the merged PR."
          else
            echo "Found _in_box/ files:"
            echo "$FILTERED_FILES"
            # 後続のステップで利用するために、出力を設定することも可能
            echo "IN_BOX_FILES<<EOF" >> $GITHUB_OUTPUT
            echo "$FILTERED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Process _in_box/ files and commit
        if: steps.identify_files.outputs.IN_BOX_FILES != ''
        run: |
          IN_BOX_FILES=$(echo "${{ steps.identify_files.outputs.IN_BOX_FILES }}" | tr '\n' ' ')
          echo "Processing identified files: $IN_BOX_FILES"

          MV_COMMANDS_SUCCESS=""
          MV_COMMANDS_FAILURE=""

          for file in $IN_BOX_FILES; do
            # Simulate issue creation success/failure for demonstration
            # In a real scenario, this would be actual issue creation logic.
            # For now, let's make it succeed for even-indexed files and fail for odd-indexed files.
            index=$(echo "$file" | cut -d'/' -f2 | sed 's/[^0-9]*//g') # Extract a numeric part for simulation
            if (( index % 2 == 0 )); then
              echo "Simulating SUCCESS for $file"
              MV_COMMANDS_SUCCESS+="git mv \"$file\" \"_done_box/$(basename $file)\" && "
            else
              echo "Simulating FAILURE for $file"
              MV_COMMANDS_FAILURE+="git mv \"$file\" \"_failed_box/$(basename $file)\" && "
            fi
          done

          # Execute move commands for successful issues
          if [ -n "$MV_COMMANDS_SUCCESS" ]; then
            echo "Executing successful file moves..."
            eval "${MV_COMMANDS_SUCCESS% && }"
          fi

          # Execute move commands for failed issues
          if [ -n "$MV_COMMANDS_FAILURE" ]; then
            echo "Executing failed file moves..."
            eval "${MV_COMMANDS_FAILURE% && }"
          fi

          if [ -n "$MV_COMMANDS_SUCCESS" ] || [ -n "$MV_COMMANDS_FAILURE" ]; then
            git add _done_box/ _failed_box/
            git commit -m "chore(actions): Process _in_box/ files"
            git push origin main
          else
            echo "No files were moved. Skipping commit."
          fi

