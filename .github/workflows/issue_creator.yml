name: Create Issue from _in_box

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  issues: write

jobs:
  create_issues:
    if: github.event.pull_request.merged == true
    runs-on: [self-hosted]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: python -m pip install PyYAML

      - name: Verify GitHub CLI
        run: gh --version

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Process issue files
        id: process_issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c '
          import os
          import subprocess
          import yaml
          import json
          import sys
          from pathlib import Path

          # --- Helper Function to run shell commands ---
          def run_command(cmd, check=True, capture=True, text=True, env=None):
              # Use a simple print to avoid quoting issues
              print("Executing command...")
              return subprocess.run(cmd, check=check, capture_output=capture, text=text, encoding="utf-8", env=env)

          # --- Main script ---
          in_box = Path("_in_box")
          done_box = Path("_done_box")
          failed_box = Path("_failed_box")

          done_box.mkdir(exist_ok=True)
          failed_box.mkdir(exist_ok=True)

          # --- Prepare auth token for gh commands ---
          github_token = os.environ.get("GITHUB_TOKEN")
          if not github_token:
              print("ERROR: GITHUB_TOKEN secret is not set.", flush=True)
              sys.exit(1)
          
          auth_env = os.environ.copy()
          auth_env["GH_TOKEN"] = github_token
          # --- End of Auth Prep ---

          # Get all existing repository labels
          try:
              result = run_command(["gh", "label", "list", "--json", "name"], env=auth_env)
              existing_labels = {label["name"] for label in json.loads(result.stdout)}
              print(f"Found existing labels: {existing_labels}", flush=True)
          except (subprocess.CalledProcessError, json.JSONDecodeError) as e:
              print(f"ERROR: Failed to fetch repository labels. Exiting. Error: {e}", flush=True)
              if isinstance(e, subprocess.CalledProcessError):
                  print(f"Stderr: {e.stderr}", flush=True)
              sys.exit(1)

          issue_files = list(in_box.rglob("*.md"))
          moved_files = False

          if not issue_files:
              print("No issue files found in _in_box. Exiting.", flush=True)
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("moved_files=false\n")
              sys.exit(0)

          for f in issue_files:
              print(f"Processing {f}...", flush=True)
              try:
                  content = f.read_text(encoding="utf-8")
                  parts = content.split("---", 2)
                  if len(parts) < 3:
                      raise ValueError("Invalid markdown format, no frontmatter found.")

                  frontmatter = yaml.safe_load(parts[1])
                  if not isinstance(frontmatter, dict):
                      raise ValueError("Frontmatter is not a valid YAML object.")

                  body = parts[2].strip()
                  title = frontmatter.get("title")
                  if not title:
                      raise ValueError("''title'' is missing in frontmatter.")

                  # --- Label Validation and Creation ---
                  required_labels = frontmatter.get("labels", [])
                  if required_labels:
                      for label in required_labels:
                          if label not in existing_labels:
                              print(f"Label ''{label}'' not found. Creating it...", flush=True)
                              try:
                                  run_command(["gh", "label", "create", label], env=auth_env)
                                  print(f"Successfully created label ''{label}''.", flush=True)
                                  existing_labels.add(label)
                              except subprocess.CalledProcessError as e:
                                  print(f"ERROR: Failed to create label ''{label}''.", flush=True)
                                  print(f"Stderr: {e.stderr}", flush=True)
                                  raise
                  # --- End of Label Logic ---

                  assignees = frontmatter.get("assignees", [])
                  
                  cmd = ["gh", "issue", "create", "--title", title, "--body", body]
                  if assignees:
                      cmd.extend(["--assignee", ",".join(assignees)])
                  if required_labels:
                      for label in required_labels:
                          cmd.extend(["--label", label])

                  # Execute issue creation
                  run_command(cmd, env=auth_env)
                  print(f"Successfully created issue for {f}", flush=True)
                  run_command(["git", "mv", str(f), str(done_box)], capture=False)
                  moved_files = True

              except Exception as e:
                  print(f"ERROR: An unexpected error occurred while processing {f}: {e}", flush=True)
                  if isinstance(e, subprocess.CalledProcessError):
                      if e.stderr:
                          print(f"Stderr: {e.stderr}", flush=True)
                  run_command(["git", "mv", str(f), str(failed_box)], capture=False)
                  moved_files = True
          
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"moved_files={str(moved_files).lower()}\n")
          '

      - name: Create Pull Request for file movements
        if: steps.process_issues.outputs.moved_files == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(issues): Move processed issue files from _in_box"
          title: "Chore: Sync processed issue files"
          body: "Automated PR to move processed issue files from `_in_box` to `_done_box` or `_failed_box`."
          branch: "chore/sync-issue-files"
          delete-branch: true