# 概要 / Summary
[ADR-003] ポーリング方式アーキテクチャへの完全移行

- Status: Accepted
- Date: 2025-11-14

## 状況 / Context

ユーザーからの戦略的指示に基づき、プロジェクトのアーキテクチャをWebhookベースから、GitHub APIを定期的に確認する「ポーリング方式」に完全に切り替えることが決定されました。この決定は、ローカルでの開発体験を簡素化し、外部に公開するエンドポイントを持つことの複雑さを排除することを目的としています。これにより、セットアップが容易になり、セキュリティリスクも低減されます。

## 決定 / Decision

今後、本プロジェクトにおけるタスク取得のメカニズムは、GitHub APIへのポーリング方式を唯一の公式な方法とします。Webhookに関連するすべての技術（APIエンドポイント、サービス、設定など）は廃止され、新規開発やリファクタリングにおいて使用を禁止します。

## 未解決の課題 (Open Issues)

本アーキテクチャへの移行に伴い、以下の課題が認識されています。これらは将来の改善タスクとして管理されます。

1.  **APIレート制限への堅牢な対応:**
    *   **課題:** 現在の実装は `PyGithub` ライブラリ内部のレート制限処理に依存しており、ETagを利用した効率的な条件付きリクエストが実装されていません。APIの利用が増加した場合、レート制限に抵触するリスクがあります。
    *   **推奨されるアクション:** `GitHubClient` にETagを利用したキャッシュ機構を導入し、不要なAPIコールを削減する。

2.  **ポーリング処理における自動リトライ戦略の欠如:**
    *   **課題:** 現在のポーリング処理 (`TaskService.start_polling`) は、`GithubException` や `RedisError` 発生時にエラーをログ出力するのみで、自動的なリトライを行いません。一時的なネットワーク障害などでポーリングが停止してしまう可能性があります。
    *   **推奨されるアクション:** `tenacity` ライブラリなどを利用し、指数バックオフを用いたリトライ戦略を実装する。

3.  **リアルタイム性の確保:**
    *   **課題:** ポーリング方式であるため、Issueの変更がシステムに反映されるまでに遅延が生じます。
    *   **推奨されるアクション:** 現状は許容範囲と判断していますが、将来的にリアルタイム性が求められる場合は、ポーリング間隔の短縮や、特定の高優先度タスクに対する動的なポーリング頻度の調整などを検討する。

## 結果 / Consequences

### メリット (Positive consequences)
- **`WebhookService` の廃止:** `github_broker/application/webhook_service.py` および関連するインターフェース（`api.py`内のエンドポイントなど）は、今後のリファクタリング作業で完全に削除されます。
- **`TaskService` の責務変更:** `TaskService` は、GitHub APIを定期的にポーリングしてIssue情報をローカルキャッシュ（Redis）に同期する責務を担うように変更されます。このポーリング処理は、独立したバックグラウンドプロセスとして起動されることを想定しています。
- **`docs/design-docs/webhook-based-architecture.md` の廃止:** このアーキテクチャドキュメントは現状と一致しなくなるため、**廃止 (Deprecated)** されます。今後のアーキテクチャに関する参照は、このADRおよび将来作成されるポーリング方式の設計ドキュメントを参照してください。

### デメリット (Negative consequences)
- (特になし)

## 検証基準 / Verification Criteria
- (TBD)

## 実装状況 / Implementation Status

完了