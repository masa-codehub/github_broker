# ADR 006: 動的役割変化とレビュー自動化アーキテクチャ

## Status

Accepted

## Context

当初のアーキテクチャでは、エージェント（クライアント）は固定的な「役割」を持っていました。そして、その役割に対応するIssueをクライアント自身がGitHub APIから検索し、タスクを選択する必要がありました。この設計には、以下の課題がありました。

1.  **静的な役割分担による非効率性:** エージェントの役割が固定されているため、対応する役割のIssueがなければ、そのエージェントはタスクが割り当てられず、遊休状態になってしまいました。これにより、システム全体のスループットが低下していました。
2.  **タスク処理順序の一貫性:** Issueを処理する優先順位のロジックが各クライアントに分散していると、ロジックの更新時に修正漏れが起きる可能性があります。その結果、意図しない順序でタスクが処理され、後工程での手戻りや、関連タスクの修正漏れに繋がるリスクがありました。
3.  **レビューワークフローの欠如:** プルリクエスト後のレビューワークフローが定義されていません。現状では新規タスク処理用のプロンプトしかなく、レビューコメントに基づいた修正タスクをエージェントに自動で割り当てる仕組みが存在しません。結果として、人間がレビュー対応を一つずつ行う必要があり、開発サイクルのボトルネックとなっています。

## Decision

これらの課題を解決するため、アーキテクチャを全面的に刷新し、以下の通り新しいワークフローと責務を定義します。

### 1. タスク駆動型の動的な役割変化

エージェントの役割を固定せず、割り当てられるタスクに応じて動的に変化させることで、エージェントの遊休状態をなくし、システム全体のスループットを向上させます。

-   **APIレスポンスの変更:** サーバーからのタスク割り当てレスポンス (`TaskResponse`) に、そのタスクを遂行するために要求される役割を示す `required_role: str` フィールドを追加します。
-   **サーバーの責務:** `TaskService`は、タスクを割り当てる際、そのIssueに付与されている役割ラベル（例: `BACKENDCODER`）を読み取り、`required_role`としてレスポンスに含めます。
-   **クライアントの責務:** クライアント (`agents_main.py`) は、タスクのレスポンスを受け取った際に`required_role`フィールドを確認し、自身の役割をその値に更新（上書き）します。
-   **APIリクエストの変更:** タスク要求APIのリクエストボディから`agent_role`を削除し、`agent_id`のみを渡すように簡素化します。

### 2. レビュータスクの自動割り当てワークフロー

`needs-review`状態のIssueを、人間のレビューを待つだけでなく、一定時間経過後にAIエージェントに「レビュータスク」として自動で割り当て、開発サイクルをさらに高速化します。

-   **タスクタイプの導入:** APIレスポンスに`task_type: str`フィールドを追加し、タスクの種類（例: `"development"`, `"review"`）をクライアントに伝えます。
-   **レビュータスクの選定:** `TaskService`は、開発タスクを探す前に、まず以下の条件を満たす「レビュータスク」を優先的に探します。
    1.  `needs-review`ラベルが付いている。
    2.  プルリクエストが紐付いている。
    3.  `needs-review`ラベルが付与されてから、**一定時間が経過**している（人間のレビュー時間を確保するため）。
-   **レビュー用プロンプトの生成:** レビュータスクを割り当てる際、`GeminiExecutor`は、紐付いているプルリクエストのURLや差分情報を含んだ、**コードレビュー実施に特化したプロンプト**を生成します。
-   **クライアントの動的コマンド切り替え:** クライアント (`agents_main.py`) は、APIレスポンスの`task_type`フィールドを確認し、`"development"`であれば開発・修正コマンドを、`"review"`であればレビュー用のコマンド（レビューコメントを生成・投稿するなど）を実行するように、その場で自身の挙動を切り替えます。

### 3. 既存の基盤技術の継続利用

-   **ハイブリッドアーキテクチャ:** バックグラウンドでのポーリングとAPIサーバーの組み合わせは、この新しいDecisionを実現するための基盤として引き続き利用します。
-   **ロングポーリング:** クライアントの待機効率を向上させるため、継続して利用します。

## Consequences

-   **エージェントの稼働率向上:** 「静的な役割分担による非効率性」という課題を、「エージェントがタスクに合わせて役割を変える」というアプローチで解決します。
-   **開発サイクルの高速化:** レビューの実施そのものがタスクとして自動化されることで、人間のレビューを待つ時間が短縮され、開発サイクル全体が高速化します。
-   **保守性と拡張性の向上:** タスク割り当てのロジックがサーバーに一元化されているため、将来的なマッチングロジックの高度化や、新しい役割の追加が容易になります。
-   **影響範囲の拡大:** この決定は、以下のコンポーネントに影響を与えます。
    -   **APIインターフェース:** タスク要求（`agent_role`削除）およびレスポンス（`required_role`, `task_type`追加）の仕様変更が必要です。
    -   **クライアント (`agents_main.py`):** サーバーから受け取った役割で自身を更新し、さらに`task_type`に応じて実行コマンドを切り替えるロジックの実装が必要です。
    -   **TaskService:** 通常の開発タスクに加え、「レビュータスク」を時間経過を条件に優先検索する、より高度なタスク選択ロジックが必要になります。
    -   **GeminiExecutor:** 新規開発用とレビュー実施用の2種類のプロンプトを生成する機能が必要になります。
