# ADR 006: 動的役割変化とレビュー自動化アーキテクチャ

## Status

Accepted

## Context

当初のアーキテクチャでは、エージェント（クライアント）は固定的な「役割」を持っていました。そして、その役割に対応するIssueをクライアント自身がGitHub APIから検索し、タスクを選択する必要がありました。この設計には、以下の課題がありました。

1.  **静的な役割分担による非効率性:** エージェントの役割が固定されているため、対応する役割のIssueがなければ、そのエージェントはタスクが割り当てられず、遊休状態になってしまいました。これにより、システム全体のスループットが低下していました。
2.  **タスク処理順序の一貫性:** Issueを処理する優先順位のロジックが各クライアントに分散していると、ロジックの更新時に修正漏れが起きる可能性があります。その結果、意図しない順序でタスクが処理され、後工程での手戻りや、関連タスクの修正漏れに繋がるリスクがありました。
3.  **レビューワークフローの欠如:** プルリクエスト後のレビューワークフローが定義されていません。現状では新規タスク処理用のプロンプトしかなく、レビューコメントに基づいた修正タスクをエージェントに自動で割り当てる仕組みが存在しません。結果として、人間がレビュー対応を一つずつ行う必要があり、開発サイクルのボトルネックとなっています。

## Decision

これらの課題を解決するため、アーキテクチャを全面的に刷新し、以下の通り新しいワークフローと責務を定義します。

### 1. タスク駆動型の動的な役割変化

エージェントの役割を固定せず、割り当てられるタスクに応じて動的に変化させることで、エージェントの遊休状態をなくし、システム全体のスループットを向上させます。

-   **APIレスポンスの変更:** サーバーからのタスク割り当てレスポンス (`TaskResponse`) に、そのタスクを遂行するために要求される役割を示す `required_role: str` フィールドを追加します。
-   **サーバーの責務:** `TaskService`は、タスクを割り当てる際、そのIssueに付与されている役割ラベル（例: `BACKENDCODER`）を読み取り、`required_role`としてレスポンスに含めます。
-   **クライアントの責務:** クライアント (`agents_main.py`) は、タスクのレスポンスを受け取った際に`required_role`フィールドを確認し、自身の役割をその値に更新（上書き）します。
-   **APIリクエストの変更:** タスク要求APIのリクエストボディから`agent_role`を削除し、`agent_id`のみを渡すように簡素化します。

### 2. `review-done`ラベルをトリガーとしたレビューワークフロー

人間のレビューとシステムの自動化を両立させつつ、プルリクエストに付与される単一のラベル`review-done`をトリガーとして、レビュータスクの割り当てを制御します。

-   **`review-done`ラベルの導入:** プルリクエストに付与される`review-done`ラベルを、AIによるレビュータスク開始の**唯一のトリガー**として定義します。
-   **ラベル付与のプロセス:**
    -   **人間による付与:** 人間のレビュー担当者は、レビュー完了後、いつでも手動で対象のプルリクエストに`review-done`ラベルを付与できます。
    -   **システムによる自動付与:** ポーリングサービスは、`needs-review`状態のIssueに紐づくプルリクエストを監視します。プルリクエストが作成されてから一定時間が経過した場合、システムが**自動で`review-done`ラベルを付与します。**
-   **レビュータスクの選定:** `TaskService`は、クライアントからリクエストがあった際、`needs-review`ラベルが付いたIssueの中から、紐づくプルリクエストに`review-done`ラベルが付与されているものを「レビュータスク」として選択します。
-   **クライアントの挙動:** （変更なし）クライアントは`task_type: "review"`を受け取り、レビュー用のコマンドを実行します。

### 3. 既存の基盤技術の継続利用

-   **ハイブリッドアーキテクチャ:** バックグラウンドでのポーリングとAPIサーバーの組み合わせは、この新しいDecisionを実現するための基盤として引き続き利用します。
-   **ロングポーリング:** クライアントの待機効率を向上させるため、継続して利用します。

## Consequences

-   **エージェントの稼働率向上:** 「静的な役割分担による非効率性」という課題を、「エージェントがタスクに合わせて役割を変える」というアプローチで解決します。
-   **開発サイクルの効率化:** 人によるレビューと、システムによる自動的なレビュータスク化が両立されることで、レビューのボトルネックが解消され、開発サイクル全体が効率化します。
-   **保守性と拡張性の向上:** タスク割り当てのロジックがサーバーに一元化されているため、将来的なマッチングロジックの高度化や、新しい役割の追加が容易になります。
-   **影響範囲の拡大:** この決定は、以下のコンポーネントに影響を与えます。
    -   **APIインターフェース:** タスク要求（`agent_role`削除）およびレスポンス（`required_role`, `task_type`追加）の仕様変更が必要です。
    -   **クライアント (`agents_main.py`):** サーバーから受け取った役割で自身を更新し、さらに`task_type`に応じて実行コマンドを切り替えるロジックの実装が必要です。
    -   **ポーリングサービス:** `needs-review`状態のPRを監視し、一定時間経過後に`review-done`ラベルを自動付与する責務が追加されます。
    -   **TaskService:** `needs-review`のIssueの中から、PRに`review-done`ラベルが付いたものを「レビュータスク」として選択するロジックが必要になります。
    -   **GeminiExecutor:** 新規開発用とレビュー実施用の2種類のプロンプトを生成する機能が必要になります。
