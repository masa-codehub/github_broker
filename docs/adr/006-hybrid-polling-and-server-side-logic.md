# ADR 006: 動的タスク割り当てとレビュー自動化アーキテクチャ

## Status

Accepted

## Context

当初のアーキテクチャでは、エージェント（クライアント）は固定的な「役割」を持っていました。そして、その役割に対応するIssueをクライアント自身がGitHub APIから検索し、タスクを選択する必要がありました。この設計には、以下の課題がありました。

1.  **静的な役割分担による非効率性:** エージェントの役割が固定されているため、対応する役割のIssueがなければ、そのエージェントはタスクが割り当てられず、遊休状態になってしまいました。これにより、システム全体のスループットが低下していました。
2.  **タスク処理順序の一貫性:** Issueを処理する優先順位のロジックが各クライアントに分散していると、ロジックの更新時に修正漏れが起きる可能性があります。その結果、意図しない順序でタスクが処理され、後工程での手戻りや、関連タスクの修正漏れに繋がるリスクがありました。
3.  **レビューワークフローの欠如:** プルリクエスト後のレビューワークフローが定義されていません。現状では新規タスク処理用のプロンプトしかなく、レビューコメントに基づいた修正タスクをエージェントに自動で割り当てる仕組みが存在しません。結果として、人間がレビュー対応を一つずつ行う必要があり、開発サイクルのボトルネックとなっています。

## Decision

これらの課題を解決するため、アーキテクチャを全面的に刷新し、以下の通り新しいワークフローと責務を定義します。

### 1. スキルベースの動的タスク割り当て

静的な`agent_role`を廃止し、エージェントの能力に応じた動的なタスク割り当てを実現します。

-   **エージェントの申告:** エージェントはタスク要求APIを呼び出す際、固定の役割ではなく、自身の持つ**スキルセット**（例: `["python", "fastapi", "react"]`）のリストを申告します。
-   **Issueの要求スキル:** 各Issueには、そのタスク遂行に必要なスキルを`skill:python`のような規約でラベル付けします。
-   **サーバーでの動的マッチング:** `TaskService`は、Issueの要求スキルラベルとエージェントの申告スキルセットを照合し、すべての要求スキルを満たすIssueのみをタスク候補とします。

### 2. レビュー駆動型の修正ワークフロー

プルリクエストへのレビューコメントをトリガーとし、修正タスクを自動的に生成・割り当てます。

-   **タスクタイプの導入:** タスクに`development`（新規開発）と`revision`（修正）の2種類を定義します。
-   **レビューコメントの監視:** バックグラウンドのポーリングサービスは、`needs-review`ラベルを持つIssueに関連するプルリクエストを監視し、**新しいレビューコメントの投稿を検知**します。
-   **修正タスクの自動生成:** コメントが投稿されると、そのIssueは自動的に`revision`タスクとして扱われ、再度タスク割り当ての対象となります。
-   **修正用プロンプトの生成:** `revision`タスクを割り当てる際、`GeminiExecutor`は**レビューコメントの内容をプロンプトに含める**ことで、エージェントが的確な修正を行えるよう指示します。

### 3. 既存の基盤技術の継続利用

-   **ハイブリッドアーキテクチャ:** バックグラウンドでのポーリングとAPIサーバーの組み合わせは、この新しいDecisionを実現するための基盤として引き続き利用します。
-   **ロングポーリング:** クライアントの待機効率を向上させるため、継続して利用します。

## Consequences

-   **エージェントの稼働率向上:** エージェントは特定の役割に縛られず、自身のスキルセットに基づいて多様なタスクを処理できるようになるため、遊休時間が大幅に削減され、システム全体のスループットが向上します。
-   **開発サイクルの高速化:** レビューコメントへの対応が自動化されることで、人間が介在するのはレビューコメントを記述するまでとなり、修正サイクルが高速化します。
-   **保守性と拡張性の向上:** タスク割り当てのロジックがサーバーに一元化されているため、将来的なマッチングロジックの高度化（例: 優先度付け）や、新しいスキルの追加が容易になります。
-   **影響範囲の拡大:** この決定は、以下のコンポーネントに影響を与えます。
    -   **APIインターフェース:** タスク要求（`agent_role` -> `skills`）およびレスポンス（`task_type`追加）の仕様変更が必要です。
    -   **ポーリングサービス:** Issueに加えて、Pull Requestのレビューコメントも監視するよう、責務が拡大します。
    -   **TaskService:** 役割ベースのフィルタリングから、スキルベースのマッチングロジックへの変更が必要です。
    -   **GeminiExecutor:** 新規開発用と修正用の2種類のプロンプトを生成する機能が必要になります。
    -   **Issue管理規約:** タスクに必要なスキルをラベルで明示する新しい規約の導入が必要です。
