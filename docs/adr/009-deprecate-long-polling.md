# 概要
ADR-009: ロングポーリング方式の廃止とシンプルポーリングへの切り替え

- **ステータス**: Completed
- **日付**: 2025-10-16
- **Completed Date**: 2025-10-19

## 背景 (Context)

現状のシステムは、エージェントがタスクを要求する際に「ロングポーリング」方式を採用しています。これは、サーバー側で応答可能なタスクが発生するまでリクエストを保留し、タスクの割り当てを即時的に行うことで、エージェントの遊休時間を削減し、システム全体のスループットを向上させることを目的としていました。

しかし、複数のエージェントが同時にタスクを待機する現在の運用状況では、タスクがない場合に多くの接続がサーバー上で保留され続けることになります。これにより、サーバーリソースの消費が増加し、また、クライアント側も不要な待機が発生するという課題が明らかになりました。

加えて、現在のシステムは、定期的にGitHub APIをポーリングしてタスク情報を内部キャッシュに同期するアーキテクチャです。このポーリング間隔に起因する遅延が元々存在するため、クライアント側でロングポーリングを行っても、タスク割り当ての即時性向上効果は限定的です。

## 決定

ロングポーリング方式を廃止し、よりシンプルなリクエスト/レスポンス方式（シンプルポーリング）に切り替える。

具体的には、エージェントがタスクを要求した際、サーバーは利用可能なタスクを一度だけチェックする。割り当て可能なタスクが存在しない場合は、リクエストを保留せず、即座に「タスクなし」という応答をクライアントに返す。

## 結果

## Consequences

### メリット (Pros)

- **リソース効率の向上**: 多数のエージェントが待機することによるサーバーの接続リソース消費と負荷を削減できる。
- **システムの単純化**: サーバー側の状態管理や非同期処理がシンプルになり、コードの可読性、保守性が向上する。
- **クライアントの自律性**: クライアントは即座に応答を受け取れるため、次の問い合わせタイミングを（例えば指数バックオフなどで）自身で制御できるようになる。

### デメリット (Cons)

- 実質的に無し。クライアントは、タスク取得の再試行ロジックを自前で実装する必要があるが、これは責務の移動と見なす。

## 検証基準 (Validation Criteria)

- `request_task` APIエンドポイントが、割り当て可能なタスクがない場合に、即座に空の応答（例: `HTTP 204 No Content` または空のJSON）を返すこと。
- サーバーログに、ロングポーリングの開始やタイムアウトに関するメッセージが出力されなくなったことを確認する。
- この変更に関連する単体テストおよび統合テストがすべてパスすること。

## 状況

## Status
完了
