# [ADR-010] CI/CDプロセスの改善による開発ワークフローの高速化と自動化

- **Status**: Completed
- **Date**: 2025-10-18
- **Completed Date**: 2025-10-19

## Context (背景)

現在のCI/CDプロセスは、プロダクトの成長に伴い、いくつかの課題を抱えています。

1.  **非効率なチェックプロセス**: CI上でリンター、フォーマッター、型チェッカー、テスターが個別のステップとして実行されており、処理が冗長です。また、ローカルの`pre-commit`フックとCIでのチェック内容が完全に一致している保証がありません。
2.  **フィードバックの遅延**: テストスイートの拡大に伴い、テスト実行時間が増加しており、開発者がPull Requestの結果を受け取るまでの待機時間が長くなっています。
3.  **手動のリリース作業**: バージョン番号の更新、CHANGELOGの作成、GitHubリリースの作成が手動で行われており、作業負荷が高いだけでなく、ヒューマンエラーが発生するリスクがあります。

これらの課題は、開発サイクルの速度を低下させ、品質の一貫性を損なう可能性があります。

## Decision (決定)

開発ワークフローの効率、速度、信頼性を向上させるため、以下の3つの主要な改善を導入します。

1.  **チェック処理の一本化**: CIワークフローをリファクタリングし、`pre-commit run --all-files` を実行する単一のステップに集約します。これにより、コードの静的解析（lint, format, type check）と単体テストを一元的に実行し、ローカル環境とCI環境でのチェックの同一性を保証します。

2.  **テストの高速化**: `pytest-xdist` をテスト依存関係に追加し、CIおよび`pre-commit`フックで`pytest`を並列実行オプション（`-n auto`）付きで実行します。これにより、テスト実行時間を大幅に短縮します。

3.  **バージョニングとリリースの自動化**: `python-semantic-release` を導入し、Conventional Commits規約に基づいたリリースプロセスを自動化します。`main`ブランチへのマージをトリガーとして、バージョンの自動更新、`pyproject.toml`への反映、CHANGELOGの生成、Gitタグの作成、GitHubリリースの作成までを全自動で行います。CIではコミットメッセージが規約に準拠しているかのチェックも行います。
    - **カスタムコミットタイプの追加**: プロジェクトのワークフローに合わせ、`epic:` のコミットで**マイナーバージョン**、`story:` のコミットで**パッチバージョン**が上がるように設定をカスタマイズします。

## Consequences (結果)

### メリット (Positive consequences)

- **保守性の向上**: CIの設定ファイル (`ci.yml`) がチェック処理を集約することでシンプルになり、管理が容易になります。
- **一貫性の確保**: ローカルとCIでのチェック内容が完全に統一され、「自分のマシンでは動いたのにCIで失敗する」といった問題を削減できます。
- **開発サイクルの高速化**: テスト実行時間が短縮され、開発者のフィードバックサイクルが高速化します。
- **信頼性の向上と作業負荷の軽減**: リリース作業が自動化されることで、ヒューマンエラーがなくなり、開発者はより価値の高い作業に集中できます。

### デメリット (Negative consequences)

- **規約への準拠**: チームメンバーは、リリースの自動化を正しく機能させるために、Conventional Commitsの規約を厳守する必要があります。
- **ツールの学習コスト**: `pre-commit`や`python-semantic-release`の挙動に慣れるまで、若干の学習コストが発生する可能性があります。

## Verification Criteria (検証基準)

この意思決定が正しく実装されたことは、以下の点で確認できます。

- CIのワークフローログにおいて、`pre-commit run --all-files` が実行され、lint, format, type, testのチェックが成功していること。
- CIのテスト実行ステップで、`pytest-xdist`によってテストが並列実行されているログが確認できること。
- `feat:`や`fix:`といった規約に従ったPull Requestを`main`にマージした際、`python-semantic-release`によって新しいバージョンのGitHubリリースが自動的に作成されること。
- `epic:`を含むコミットをマージするとマイナーバージョンが上がり、`story:`を含むコミットをマージするとパッチバージョンが上がることが確認できること。

## Implementation Status (実装状況)
完了
