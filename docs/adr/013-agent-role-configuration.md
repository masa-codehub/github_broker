# 概要 / Summary
[ADR-013] エージェント役割定義の外部設定化

- **Status**: 提案中
- **Date**: 2025-10-23

## 状況 / Context

現状のシステムでは、タスクを処理できるエージェントの役割（例: `BACKENDCODER`, `SYSTEM_ARCHITECT`）が、`github_broker/application/task_service.py`内の`AGENT_ROLES`というクラス変数にハードコードされています。

この実装には、以下の問題点があります。

-   **柔軟性の欠如:** 新しい役割を持つエージェントを追加する場合、ソースコードを直接変更し、アプリケーションを再デプロイする必要があります。
-   **メンテナンス性の低下:** 役割のリストがコード内に埋もれているため、現在どのような役割が有効であるかを一覧で確認することが困難です。
-   **設定管理の一貫性欠如:** 他の多くの設定値が`config.py`や環境変数で管理されているにもかかわらず、エージェントの役割だけがコード内で管理されており、一貫性がありません。

最近、新しいエージェントが追加された際に、このハードコードが原因でタスクが自動的に割り当てられないという問題が発生しました。将来的にエージェントの種類が増減することを見据え、より柔軟でメンテナンスしやすい構成に変更する必要があります。

## 決定 / Decision

エージェントの役割（`AGENT_ROLES`）の定義を、ソースコード内のハードコードから設定ファイル（`config.py`）経由で管理するように変更します。

1.  **`config.py`の`Settings`クラスへの追加:**
    -   `github_broker/infrastructure/config.py` の `Settings` クラスに、`AGENT_ROLES: set[str]` という新しい設定項目を追加します。
    -   この設定値は、カンマ区切りの文字列として環境変数 `AGENT_ROLES` から読み込まれるようにします。（例: `AGENT_ROLES="ROLE1,ROLE2,ROLE3"`）
    -   環境変数が設定されていない場合のデフォルト値として、既存の役割リストを保持します。

2.  **`TaskService`の修正:**
    -   `TaskService`のコンストラクタは、`Settings`オブジェクトをインジェクションされるように既に設定されています。
    -   `TaskService`内のクラス変数 `AGENT_ROLES` を削除します。
    -   代わりに、コンストラクタで受け取った`settings`オブジェクトから役割リストを取得し、インスタンス変数 `self.agent_roles` に格納します。
    -   クラス内で `AGENT_ROLES` を参照しているすべての箇所を、`self.agent_roles` を参照するように変更します。

## 結果 / Consequences

### メリット (Positive consequences)

-   **柔軟性の向上:** ソースコードの変更や再デプロイを行うことなく、環境変数を変更するだけで、動的にエージェントの役割を追加、変更、削除できるようになります。
-   **メンテナンス性の向上:** `.env`ファイルやデプロイ設定を見れば、現在有効なエージェントの役割を一覧で簡単に確認できるようになります。
-   **設定の一元管理:** すべての環境依存の設定が`config.py`と環境変数に集約され、設定管理の一貫性が向上します。

### デメリット (Negative consequences)

-   **設定の分散:** 役割定義という情報が、コードベースからインフラの設定（環境変数や`.env`ファイル）に移動します。ただし、これは`.env.sample`ファイルにデフォルト値を記述することで、開発者がどのような設定が必要かを把握しやすくすることができます。

## Verification Criteria (検証基準)

この意思決定が正しく実装されたことは、以下の方法で確認できます。

-   環境変数 `AGENT_ROLES` に、既存の役割に加えて新しい役割（例: `NEW_AGENT_ROLE`）を追加してアプリケーションを起動する。
-   GitHubリポジトリで、`NEW_AGENT_ROLE` ラベルが付いた新しいIssueを作成する。
-   システムがこのIssueをタスクとして正しく認識し、エージェントに割り当てることをログなどで確認できること。
-   環境変数 `AGENT_ROLES` を設定しない場合でも、既存のデフォルトの役割が問題なく機能すること。

## Implementation Status (実装状況)
未着手