# 概要 / Summary
[ADR-015] 厳格な優先度バケットによるタスク割り当て

- Status: 提案中
- Date: 2025-10-23

## 状況 / Context

現在のタスク割り当てロジックは、割り当て可能なすべてのIssueを優先度（P0, P1, ...）でソートし、最も優先度の高いものから順にエージェントに割り当てる「ベストエフォート方式」です。これにより、エージェントの稼働率を最大化しています。

しかし、この方式では、例えばP0のIssueに対するプルリクエストがレビュー中であっても、エージェントは次に優先度の高いP1のIssueに着手してしまいます。これにより、Issue間の前後関係（依存関係）を厳密に管理したい、という要件を満たすことができません。

議論の結果、エージェントの遊休時間が発生する可能性を受け入れた上で、より厳格な優先度管理を導入し、ワークフローの予測可能性と依存関係の解決を優先する方針が決定されました。

## 決定 / Decision

タスク割り当てロジックを、「厳格な優先度バケット方式」に変更します。これは、ある優先度レベルのIssueがすべてクローズされるまで、次の優先度レベルのIssueには一切着手しない、というルールです。

新しいアルゴリズムは以下の通りです。

1.  **現在の最高優先度の決定:**
    -   まず、GitHubリポジトリ内に存在する**オープン状態**のIssueの中から、最も高い優先度レベル（例: `P0`）を特定します。

2.  **タスク候補のフィルタリング:**
    -   `TaskService`は、上記で特定した最高優先度レベルのラベルを持つIssueのみを、タスク割り当ての候補とします。
    -   例えば、`P0`ラベルを持つオープンなIssueが一つでも存在する限り、`P1`以下のラベルを持つIssueは、たとえ割り当て可能な状態であっても、候補に含めません。

3.  **タスクの割り当て:**
    -   フィルタリングされた最高優先度の候補リストの中から、現在作業中でないIssueをエージェントに割り当てます。

この変更により、優先度レベルが、後続の優先度レベル全体の進行をブロックする「ゲート」として機能するようになります。

## 結果 / Consequences

### メリット (Positive consequences)

-   **厳格なワークフローの強制:** 「すべてのP0を完了させてからP1に進む」といった、明確で予測可能な開発プロセスをシステムレベルで強制できます。
-   **暗黙的な依存関係の管理:** 依存するIssueをP1、依存されるIssueをP0に設定することで、P0がクローズされるまでP1に着手しない、という依存関係を管理できます。

### デメリット (Negative consequences)

-   **システム全体のスループット低下:** 一つの高優先度Issueのレビューやマージが滞ると、後続のすべての低優先度タスクがブロックされ、システム全体のエージェントが待機状態になる可能性があります。これは、今回の意思決定で受容されたトレードオフです。

## 検証基準 / Verification Criteria

この意思決定が正しく実装されたことは、以下の方法で確認できます。

1.  オープン状態で`P0`ラベルのIssueと`P1`ラベルのIssueが両方存在する場合、`P1`のIssueは決してエージェントに割り当てられないこと。
2.  すべての`P0`のIssueがクローズされた後、エージェントがタスクをリクエストした際に、初めて`P1`のIssueが割り当てられること。

## 実装状況 / Implementation Status
未着手