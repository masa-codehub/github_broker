# 概要 / Summary
[ADR-019] コミット時Issueデータ検証の導入によるワークフローの堅牢化

- Status: 承認済み
- Date: 2025-11-25

## 状況 / Context

**根本的な問題:** 現在のIssue作成プロセスは、リポジトリにマージされたMarkdownファイルが、後続の自動処理（Issue化）の要件を完全に満たしているという暗黙の信頼に基づいています。しかし、この信頼が裏切られた場合（例：必須データが欠けている）、ワークフローが実行時エラーで失敗し、手動での介入が必要になっていました。

**具体的な事象:**
1.  **データ品質の問題:** Issueのタイトルやラベルとなるべきメタデータは、MarkdownファイルのYAMLフロントマターに記述されます。このフロントマターが存在しない、または形式が不正なファイルが `main` ブランチにマージされると、Issue作成スクリプトがデータ不足で異常終了していました。これは、データソースの品質が保証されていないことに起因します。
2.  **実行権限の問題 (解決済み):** 以前は、処理済みファイルを移動するためにワークフローが `main` ブランチへ直接 `push` を試み、ブランチ保護ルールに違反して失敗していました。**調査の結果、この問題は既に `create-pull-request` アクションの導入によって解決済みであることが判明しています。**

**解決すべき課題:** したがって、残された中核的な課題は、「Issue化されるデータが、リポジトリに取り込まれる前、すなわちコミットの時点で、その構造と品質が保証される仕組みをいかにして構築するか」という点にあります。この「シフトレフト」アプローチにより、ワークフロー全体の信頼性と安定性を抜本的に向上させる必要があります。

## 決定 / Decision

**目的志向の決定:**
開発プロセスのできるだけ早い段階でIssueデータの品質を保証するため、**コミット時におけるIssue用Markdownの構造検証メカニズムを導入します。** これにより、不正なデータがリポジトリに混入することを未然に防止し、下流の自動化プロセスの成功率を最大化します。

**具体的な実現方法:**
このメカニズムは、既存の `pre-commit` フックである `doc-validator` の責務を拡張することで実現します。

1.  **検証対象:** `_in_box` ディレクトリにコミットされるすべてのMarkdownファイル。
2.  **検証ロジック:**
    *   **フロントマターの存在確認:** ファイルは `---` で区切られた有効なYAMLフロントマターを持つ必要があります。これはIssue化のためのデータソースとして不可欠です。
    *   **必須フィールドの検証:** Issueのタイトルとして使用される `title` フィールドが、空でない文字列として存在することを保証します。
    *   **推奨フィールドの型検証:** Issueのラベルや関連Issueとして解釈される `labels` や `related_issues` フィールドが存在する場合、それぞれが期待される型（文字列のリスト、数値のリスト）に準拠していることを検証します。これにより、データパース時のエラーを防ぎます。
3.  **実装の詳細:**
    *   この検証ロジックは、`issue_creator_kit` パッケージ内の `application/validation_service.py` に `validate_frontmatter` 関数として実装します。
    *   CLIのエントリーポイントである `interface/validation_cli.py` は、この新しいサービス関数を呼び出し、検証結果に応じて適切な終了コード（成功時は0, 失敗時は1）を返す責務を負います。
    *   `tests/application/test_validation_service.py` に、上記検証ロジックの正常系・異常系を網羅する単体テストを追加し、その品質を担保します。

**意図:** この決定の核心的な意図は、手続き的な修正を行うことではなく、**「リポジトリの状態は常に正である」**という原則を強制する仕組みを導入することにあります。コミットという最も早い段階でデータの正しさを保証することで、CI/CDパイプライン全体の信頼性を高め、開発者が安心して自動化ワークフローを利用できる環境を構築します。

## 結果 / Consequences

### メリット (Positive consequences)
- **早期フィードバック:** 不正なフォーマットはコミット時点で即座に開発者に通知され、手戻りが最小限に抑えられます。
- **信頼性の向上:** `main`ブランチにマージされるすべてのIssue用ファイルは、常に処理可能な状態であることが保証されます。
- **保守性の向上:** 検証ロジックが一箇所 (`doc-validator`) に集約されるため、将来のルール変更が容易になります。

### デメリット (Negative consequences)
- **開発初期の制約:** 新たにプロジェクトに参加した開発者は、コミット前に `pre-commit install` を実行し、この検証ルールを理解する必要があります。

## 検証基準 / Verification Criteria
- `title`フィールドを持たない、または`labels`の型が不正な`.md`ファイルを`_in_box`にコミットしようとすると、`pre-commit`フックがエラーを返し、コミットが失敗すること。
- 上記の検証をパスする有効なファイルは、問題なくコミットできること。

## 実装状況 / Implementation Status
(未着手)