# 運用・デプロイ要件定義書

## 1. 概要

このドキュメントは、`github-broker`システムを本番環境（Production）で安定的かつ安全に稼働させるために必要となる、非機能要件を定義します。

## 2. ターゲット環境

- **プラットフォーム:** **Google Cloud Run**
- **選定理由:**
    - **サーバーレス:** インフラ管理のオーバーヘッドが少なく、アプリケーションのデプロイに集中できます。
    - **自動スケーリング:** リクエスト数に応じてコンテナのインスタンス数を自動で増減させるため、コスト効率と可用性のバランスに優れています。
    - **コンテナベース:** `Dockerfile` を用いてビルドされたコンテナイメージをそのままデプロイでき、ローカル環境との一貫性を保てます。
    - **エコシステム:** Google Cloudの他のサービス（Logging, Monitoring, IAPなど）との親和性が非常に高いです。

## 3. パフォーマンス要件

- **最大エージェント数:** 50
    - 同時にタスクを要求する可能性がある、アクティブなエージェントの最大数。
- **想定RPS (Requests Per Second):** 平均 1 RPS, ピーク時 5 RPS
    - 各エージェントが約10秒に1回の頻度でタスクを要求するシナリオを想定しています。
- **許容レスポンスタイム:**
    - **P95:** 2秒以内
    - **P99:** 5秒以内
    - GitHub APIへの外部リクエストや、Issueの検索・フィルタリング処理が含まれるため、一定の時間を許容します。
- **補足:**
    - 上記の数値は、中小規模のデプロイメントを想定した初期目標値です。実際の性能は負荷試験を通じて計測し、本番環境のモニタリング結果に基づいて継続的に見直す必要があります。

## 4. モニタリング要件

- **利用ツール:** **Google Cloud Monitoring**
- **収集メトリクス:**
    - **Cloud Runネイティブメトリクス:**
        - `Request count`: リクエスト数（レスポンスコード別の内訳を含む）
        - `Request latencies`: リクエストのレイテンシ（パーセンタイル値）
        - `Container CPU utilization`: コンテナのCPU使用率
        - `Container memory utilization`: コンテナのメモリ使用率
        - `Container instance count`: 稼働中のコンテナインスタンス数
    - **カスタムメトリクス:** (将来的な検討)
        - `Assigned_task_count`: 割り当てに成功したタスク数
        - `No_task_found_count`: 割り当て可能なタスクが見つからなかった回数
- **アラート条件:**
    - `5xxエラー率の急増`: 5分間のHTTPレスポンスコード5xx系の割合が1%を超えた場合。
    - `レイテンシの悪化`: P95レスポンスタイムが5秒を5分間継続して超えた場合。
    - `CPU使用率の高止まり`: コンテナのCPU使用率が80%を10分間継続して超えた場合。

## 5. ロギング戦略

- **ログ集約:** **Google Cloud Logging**
    - Cloud Runは標準でコンテナの標準出力（stdout）および標準エラー出力（stderr）を自動的にCloud Loggingに転送するため、特別な設定は不要です。
- **ログフォーマット:** **JSON (構造化ロギング)**
    - ログはJSON形式で出力し、`severity`, `message`, `request_id`, `agent_id` などのフィールドを含めることで、検索性と分析性を向上させます。
    - **例:**
      ```json
      {
        "severity": "INFO",
        "message": "Task assigned successfully",
        "request_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
        "agent_id": "my-agent-001",
        "issue_id": 123
      }
      ```
- **保存期間:** 90日間
    - トラブルシューティングや監査の要件を考慮し、デフォルトで90日間ログを保持します。

## 6. セキュリティ要件

- **APIエンドポイントの認証:**
    - **本番環境:** **Identity-Aware Proxy (IAP)** を主要な認証方式として採用します。Googleサービスアカウントを利用して認証を行い、許可されたエージェントからのリクエストのみを受け付けます。
    - **開発・テスト環境:** IAPの利用が困難なシナリオ（ローカルからのテストなど）のために、APIキーによる認証も代替手段として提供します。
- **ネットワークポリシー:**
    - Cloud Runの**Ingress設定**を「内部トラフィックとCloud Load Balancingからのトラフィックのみ許可」に設定し、意図しない外部からの直接アクセスを遮断します。
    - **補足:** この構成は、外部からのアクセスを制御するために**外部HTTP(S)ロードバランサ**の設置が必須となります。IAPを有効化する場合も同様です。
- **シークレット管理:**
    - `GITHUB_TOKEN` などの機密情報は、**Google Secret Manager** を利用して安全に管理し、実行時にコンテナに環境変数として渡します。

## 7. デプロイ戦略

- **デプロイ方式:** **Cloud Runのトラフィック分割を利用したカナリアリリース**
    - 新しいリビジョンに少量のトラフィック（例: 10%）を流し、エラー率やレイテンシに異常がないことを確認した上で、段階的にトラフィックを100%に移行します。これにより、問題が発生した場合の影響範囲を最小限に抑え、安全なロールアウトを実現します。
- **ロールバック:**
    - デプロイ後に問題が検知された場合は、即座に安定している旧リビジョンにトラフィックを100%戻すことでロールバックします。
