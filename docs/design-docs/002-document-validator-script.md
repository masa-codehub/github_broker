# 概要 / Overview
デザインドキュメント: ドキュメント検証スクリプト

- **Author(s)**: CONTENTS_WRITER (Acting as TECHNICAL_DESIGNER)
- **Status**: 承認済み
- **Last Updated**: 2025-10-26

## 背景と課題 / Background

本プロジェクトでは、ADR (Architecture Decision Records), Design Docs, そして `plans` 配下の計画ファイル (Epics, Stories, Tasks) といった、多数のドキュメントが開発プロセスの中核を担っています。これらのドキュメントの一貫性と品質を維持することは、プロジェクトの透明性とメンテナンス性を保つ上で極めて重要です。

しかし、これらのドキュメントのフォーマット（必須セクションの有無、命名規則、フォルダ構成など）は、現状ではレビュアーによる手動での確認に依存しています。これにより、以下のような課題が生じています。

-   **抜け漏れの発生:** 人間の目によるレビューでは、必須項目の抜け漏れや、規約違反を完全には防ぎきれない。
-   **レビュー負荷の増大:** レビュアーは、本来集中すべき設計やロジックの内容よりも、フォーマットのチェックに時間を割かれてしまう。
-   **規約の形骸化:** プロジェクトが拡大するにつれて、規約の遵守が徹底されにくくなる。

これらの課題を解決し、ドキュメントの品質を自動的に保証する仕組みが必要です。

## ゴール / Goals

### 機能要件 / Functional Requirements
- ADR, Design Doc, `plans` 配下のMarkdownドキュメントのフォーマットを自動的に検証する。
- ファイル名、フォルダ構成、必須セクションの有無を検証する。
- CIプロセスに統合し、規約違反を自動的に検出する。

### 非機能要件 / Non-Functional Requirements
- 検証スクリプトは高速に実行できること。
- エラーメッセージは開発者が問題を特定しやすいように具体的であること。

## 設計 / Design

### ハイレベル設計 / High-Level Design

このスクリプトは、`pre-commit` フックを通じて実行され、引数として渡されたファイルリストに対して、命名規則、フォルダ構造、必須セクションの存在を検証する。

### 詳細設計 / Detailed Design

#### 3.1. エントリーポイント: `main()` 関数

- **責務:** CLIからの実行を受け付け、検証プロセス全体を統括する。
- **処理フロー:**
    1.  CLI引数として渡された検証対象のファイルリスト（`pre-commit` から渡される）を取得する。
    2.  各ファイルに対して `validate_file()` を呼び出す。
    3.  検証中にエラーが検出された場合、エラーメッセージを標準エラー出力 (`sys.stderr`) に出力する。
    4.  全てのエラーを収集した後、エラーが一つでもあれば非ゼロの終了コード (`sys.exit(1)`) で終了する。
    5.  エラーがなければ、正常終了コード (`sys.exit(0)`) で終了する。

#### 3.2. ファイル検証: `validate_file(filepath)` 関数

- **責務:** 単一のファイルパスを受け取り、そのファイルに対して全ての検証ルールを適用する。
- **処理フロー:**
    1.  `check_naming_convention(filepath)` を実行。
    2.  `check_folder_structure(filepath)` を実行。
    3.  `check_required_sections(filepath)` を実行。
    4.  検出された全てのエラーメッセージのリストを返す。

#### 3.3. ルールチェック関数群 (Rule Checkers)

##### 3.3.1. `check_naming_convention(filepath)`

- **責務:** ファイルパスに応じて、各ディレクトリの命名規則（接頭辞やフォーマット）が守られているか検証する。
- **ロジック:**
    - ファイルパスが `plans/` 配下にある場合:
        - ファイル名が `epic-`, `story-`, `task-` のいずれかで始まっているかチェックする。
    - ファイルパスが `docs/adr/` 配下にある場合:
        - ファイル名が `[ADR-XXX]`（XXXはゼロ埋め3桁の番号）で始まっているかチェックする。
    - ファイルパスが `docs/design-docs/` 配下にある場合:
        - ファイル名が `[Design Doc XXX]`（XXXはゼロ埋め3桁の番号）で始まっているかチェックする。

##### 3.3.2. `check_folder_structure(filepath)`

- **責務:** `plans` 配下のファイルが、ファイル名と一致する適切なサブディレクトリに配置されているか検証する。
- **ロジック:**
    - ファイル名が `epic-*` で始まる場合、そのファイルが `plans/` 直下（サブディレクトリではなく）に存在するかチェックする（例: `plans/epic-*.md`）。
    - ファイル名が `story-*` で始まる場合、そのファイルが `plans/*/stories/` の形式のサブディレクトリ内に存在するかチェックする。
    - ファイル名が `task-*` で始まる場合、そのファイルが `plans/*/tasks/` の形式のサブディレクトリ内に存在するかチェックする。

##### 3.3.3. `check_required_sections(filepath)`

- **責務:** ファイルの内容を読み込み、ドキュメントタイプに応じた必須セクション（Markdownヘッダー）が全て存在するか検証する。
- **ロジック:**
    - ファイルパスからドキュメントタイプ（例: ADR, Design Doc, Epic/Story/Task）を特定する。
    - ドキュメントタイプに対応する**必須セクションリスト**（例: ADRの場合は `# [ADR-XXX] Title`, `## Context (背景)`, `## Decision (決定)`, `## Consequences (結果)` など）を取得する。
    - **ヘッダー解析ルール:**
        - ヘッダーの前後にある空白（スペース）は無視する（トリムする）。
        - 大文字・小文字は区別する（完全一致を要求）。
        - コードブロック（` ``` `）内のヘッダーは無視する。
    - **タイトル整合性チェック (ADR/Design Doc):**
        - タイトルヘッダー（例: `# [ADR-XXX] Title`）が存在することをチェックする。
        - タイトル内の番号 (`XXX`) が、ファイル名に含まれる番号と一致することを検証する。
        - タイトル部分 (`Title`) が空でないことを検証する。
    - ファイル内容を解析し、必須セクションが全て含まれているかチェックする。

## 検討した代替案 / Alternatives Considered

- なし

## セキュリティとプライバシー / Security & Privacy

- このスクリプトはファイルの内容を読み取るが、外部への送信は行わないため、セキュリティ上のリスクは低い。

## 未解決の問題 / Open Questions & Unresolved Issues

- なし

## 検証基準 / Verification Criteria

- `pre-commit`フックが、規約違反のドキュメントのコミットをブロックすること。
- CIが、規約違反のドキュメントを含むPRを失敗させること。

## 実装状況 / Implementation Status
完了