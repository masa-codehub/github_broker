# 概要 / Overview
デザインドキュメント: プロンプトテンプレートの更新

- **Author(s)**: SYSTEM_ARCHITECT
- **Status**: 提案中
- **Last Updated**: 2025-10-23

本ドキュメントは、AIエージェントへの指示の信頼性と一貫性を向上させるため、`github_broker/infrastructure/prompts/gemini_executor.yml` に定義されている2つの主要プロンプトテンプレート (`prompt_template` および `review_fix_prompt_template`) の更新内容を定義します。

具体的には、エージェントが従うべき手順を、より明確かつ詳細なステップ・バイ・ステップ形式に修正します。

## 背景と課題

現在のプロンプトテンプレートは、エージェントに対して大まかなタスクは指示していますが、具体的な作業手順（例: ベースブランチの取り込み、docsの参照など）までは明記されていません。

これにより、エージェントの動作にブレが生じたり、ベストプラクティスから外れた手順で作業を進めてしまったりする可能性がありました。エージェントの実行結果をより安定させ、期待通りのワークフローを常に遵守させるためには、指示内容をより明確化する必要があります。

## ゴール / Goals

- エージェントのタスク実行における信頼性・一貫性を向上させる。
- 新規開発とレビュー修正の両方で、エージェントが常にベストプラクティスに沿ったワークフローを辿ることを保証する。
- エージェントへの指示を明確にし、タスクの成功率を高める。

## 設計 / Design

`github_broker/infrastructure/prompts/gemini_executor.yml` ファイル内の2つのテンプレートを、以下の通り最終版に更新します。

### `prompt_template` の最終版 (新規開発用)

```yaml
prompt_template: >
  あなたはソフトウェア開発を支援するAIエージェントです。@.gemini/GEMINI.md を読み込み、役割と責務を完全に理解してください。
  Issue `{html_url}` を解決するため、以下のタスクを実行してください。

  **あなたのタスク:**
  1. @.gemini/GEMINI.md を読み込み、あなたの役割を再確認する。
  2. docs/ を読み込み、プロジェクトの全体像と規約を理解する。
  3. Issue `{html_url}` の内容を完全に理解し、作業を計画し、ユーザーに宣言する。
  4. Issueで指定されている作業ブランチ `{branch_name}` に切り替える。
  5. ベースブランチ `{base_branch_name}` の最新の変更を取り込む。
  6. 策定した作業計画とあなたの行動規範に従って、作業を完了させる。
  7. 作業が完了したら、変更をコミットし、プルリクエストを作成する。

  **注意事項:**
  - 変更は既存のコードベースのスタイルと規約に従うこと。
  - シェルスクリプトは使用せず、単体テストを行いたい場合はコミットしpre-commitフックを利用すること。
  - 必要な情報が不足している場合は、追加の情報を要求すること。
  - 問い合わせはIssueまたはPull Requestにコメントとして投稿すること。
  - 常に安全かつ効率的な方法で作業を進めること。
```

### `review_fix_prompt_template` の最終版 (レビュー修正用)

```yaml
review_fix_prompt_template: >
  あなたはソフトウェア開発を支援するAIエージェントです。@.gemini/GEMINI.md を読み込み、役割と責務を完全に理解してください。
  以下のコンテキストとレビューコメントに基づき、プルリクエストを修正するため、以下のタスクを実行してください。

  **あなたのタスク:**
  1. @.gemini/GEMINI.md を読み込み、あなたの役割を再確認する。
  2. docs/ を読み込み、プロジェクトの全体像と規約を理解する。
  3. 以下のコンテキストにあるレビューコメントを完全に理解し、修正作業を計画し、ユーザーに宣言する。
  4. プルリクエストで指定されている作業ブランチに切り替える。
  5. 策定した作業計画とあなたの行動規範に従って、修正を完了させる。
  6. ベースブランチ `{base_branch_name}` の最新の変更を取り込み、コンフリクトがあれば解消する。
  7. 修正が完了したら、変更をコミットし、プルリクエストを更新する。

  **注意事項:**
  - 変更は既存のコードベースのスタイルと規約に従うこと。
  - シェルスクリプトは使用せず、単体テストを行いたい場合はコミットしpre-commitフックを利用すること。
  - 必要な情報が不足している場合は、追加の情報を要求すること。
  - 問い合わせはIssueまたはPull Requestにコメントとして投稿すること。
  - 常に安全かつ効率的な方法で作業を進めること。

  ---
  **コンテキスト:**
  - **プルリクエストのURL:** {pr_url}
  - **レビューコメント:** 
  {review_comments}
```

## 考慮事項 / Considerations

### `{base_branch_name}` 変数の導入

プロンプトの指示をより正確にするため、ベースブランチ名を `{base_branch_name}` という変数で扱うように変更します。これを実現するには、プロンプトのテキスト変更に加え、以下のバックエンド側のアーキテクチャ変更が必要です。

1.  **データ取得処理の拡張:** Issueの情報を取得するコンポーネント（`TaskService`等を想定）が、Issueのペイロードからベースブランチ名（`base.ref`）を取得する。
2.  **Redisへの保存:** 取得したベースブランチ名を、タスク情報を格納するRedisのハッシュに `base_branch_name` として保存する。
3.  **Executorの修正:** `GeminiExecutor`が、Redisから `base_branch_name` を読み込み、プロンプトテンプレートの変数を置換する。

### `{review_comments}` 変数の扱い

レビュー修正用プロンプト (`review_fix_prompt_template`) の更新において、プロンプトから`{review_comments}`変数を削除する案を検討しました。これは、「エージェントはPRのURLさえあれば、そこから自律的にレビューコメントを読み取れるはずだ」という仮説に基づきます。

しかし、現在の`gemini_executor.py`の実装が、プログラム側で取得したレビューコメントをこの変数に埋め込むことを前提としています。プロンプトからこの変数を削除すると、プログラムの実行時エラーに繋がります。

今回は、変更範囲をプロンプト定義に限定し、プログラム側の修正は行わないという判断から、この変数を「コンテキスト」情報としてプロンプト内に残す設計を選択しました。将来的に`gemini_executor.py`をリファクタリングする際に、この依存関係を解消することが望ましいです。

## Verification Criteria (検証基準)

本設計が正しく実装されたことは、以下の方法で確認できます。

- 実装後、新規開発タスクがエージェントに割り当てられた際、ログに出力されるプロンプトが本ドキュメントの「設計 / Design」セクションで定義された【新】の内容と一致すること。
- 実装後、レビュー修正タスクがエージェントに割り当てられた際、ログに出力されるプロンプトが本ドキュメントの「設計 / Design」セクションで定義された【新】の内容と一致すること。