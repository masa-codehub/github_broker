# 概要 / Overview
デザインドキュメント: プロンプトテンプレートの更新

- **Author(s)**: SYSTEM_ARCHITECT
- **Status**: 提案中
- **Last Updated**: 2025-10-23

本ドキュメントは、AIエージェントへの指示の信頼性と一貫性を向上させるため、`github_broker/infrastructure/prompts/gemini_executor.yml` に定義されている2つの主要プロンプトテンプレート (`prompt_template` および `review_fix_prompt_template`) の更新内容を定義します。

具体的には、エージェントが従うべき手順を、より明確かつ詳細なステップ・バイ・ステップ形式に修正します。

## 背景と課題

現在のプロンプトテンプレートは、エージェントに対して大まかなタスクは指示していますが、具体的な作業手順（例: ベースブランチの取り込み、docsの参照など）までは明記されていません。

これにより、エージェントの動作にブレが生じたり、ベストプラクティスから外れた手順で作業を進めてしまったりする可能性がありました。エージェントの実行結果をより安定させ、期待通りのワークフローを常に遵守させるためには、指示内容をより明確化する必要があります。

## ゴール / Goals

- エージェントのタスク実行における信頼性・一貫性を向上させる。
- 新規開発とレビュー修正の両方で、エージェントが常にベストプラクティスに沿ったワークフローを辿ることを保証する。
- エージェントへの指示を明確にし、タスクの成功率を高める。

## 設計 / Design

`github_broker/infrastructure/prompts/gemini_executor.yml` ファイル内の2つのテンプレートを、以下の通り変更します。

### `prompt_template` の変更 (新規開発用)

**【現行】**
```yaml
prompt_template: >
  あなたはソフトウェア開発を支援するAIエージェントです。@.gemini/GEMINI.md を読み込むことで役割と責務を完全に理解してください。
  Issue`{html_url}`を読み込み、Issueを解決するための適切なアクションを計画し、実行してください。

  **あなたのタスク:**
  1. 上記のIssueの内容を完全に理解する。
  2. 解決策を考案し、必要に応じてコードの変更、テストの追加、ドキュメントの更新などを行う。
  3. 変更は指定されたブランチ（{branch_name}）で行う。
  4. 作業が完了したら、変更をコミットし、プルリクエストを作成する。
...
```

**【新】**
```yaml
prompt_template: >
  あなたはソフトウェア開発を支援するAIエージェントです。

  ## コーディング実行
  以下の手順に沿って、全力で作業を完了させて下さい。
  1. @.gemini/GEMINI.md を読み込み、役割を完全に理解する。
  2. docsを読み込み、プロジェクトを理解する。
  3. Issue `{html_url}`を読み込み、作業をプランニングする。
  4. Issueで指定されている作業用のブランチ `{branch_name}` に切り替える。
  5. ベースブランチを取り込み最新の状態を保つ。
  6. 作業プランとあなたの行動規範に従って作業を完了させる。
  7. プルリクエスト作成する。
...
```

### `review_fix_prompt_template` の変更 (レビュー修正用)

**【現行】**
```yaml
review_fix_prompt_template: >
  あなたはソフトウェア開発を支援するAIエージェントです。@.gemini/GEMINI.md を読み込むことで役割と責務を完全に理解してください。
  以下のプルリクエストとレビューコメントを読み込み、指摘された内容を修正してください。

  **あなたのタスク:**
  1. プルリクエストのURLとレビューコメントの内容を完全に理解する。
  2. レビューコメントの指摘事項を解決するためのコード修正を行う。
  3. 修正が完了したら、変更をコミットし、プルリクエストを更新する。

  **プルリクエストのURL:** {pr_url}
  **レビューコメント:** {review_comments}
...
```

**【新】**
```yaml
review_fix_prompt_template: >
  あなたはソフトウェア開発を支援するAIエージェントです。

  以下の手順に沿って、全力で作業を完了させて下さい。
  1. @.gemini/GEMINI.md を読み込み、役割を完全に理解する。
  2. docsを読み込み、プロジェクトを理解する。
  3. プルリクエスト `{pr_url}` のレビューコメントを読み込み、作業をプランニングする。
  4. プルリクエストで指定されている作業ブランチに切り替える。
  5. 作業プランとあなたの行動規範に従って作業を完了させる。
  6. ベースブランチを取り込み最新状態にし、コンフリクトを解消してください。
  7. プルリクエスト更新する。

  ---
  **コンテキスト:**
  - **プルリクエストのURL:** {pr_url}
  - **レビューコメント:** 
  {review_comments}
...
```

## 考慮事項 / Considerations

レビュー修正用プロンプト (`review_fix_prompt_template`) の更新において、プロンプトから`{review_comments}`変数を削除する案を検討しました。これは、「エージェントはPRのURLさえあれば、そこから自律的にレビューコメントを読み取れるはずだ」という仮説に基づきます。

しかし、現在の`gemini_executor.py`の実装が、プログラム側で取得したレビューコメントをこの変数に埋め込むことを前提としています。プロンプトからこの変数を削除すると、プログラムの実行時エラーに繋がります。

今回は、変更範囲をプロンプト定義に限定し、プログラム側の修正は行わないという判断から、この変数を「コンテキスト」情報としてプロンプト内に残す設計を選択しました。将来的に`gemini_executor.py`をリファクタリングする際に、この依存関係を解消することが望ましいです。

## Verification Criteria (検証基準)

本設計が正しく実装されたことは、以下の方法で確認できます。

- 実装後、新規開発タスクがエージェントに割り当てられた際、ログに出力されるプロンプトが本ドキュメントの「設計 / Design」セクションで定義された【新】の内容と一致すること。
- 実装後、レビュー修正タスクがエージェントに割り当てられた際、ログに出力されるプロンプトが本ドキュメントの「設計 / Design」セクションで定義された【新】の内容と一致すること。