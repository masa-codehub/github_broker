# 概要 / Overview
デザインドキュメント: エージェント役割定義の外部設定化

- Status: 承認済み
- Date: 2025-10-23

## 背景と課題 / Background

現状のシステムでは、タスクを処理できるエージェントの役割（例: `BACKENDCODER`, `SYSTEM_ARCHITECT`）が、`github_broker/application/task_service.py`内の`AGENT_ROLES`というクラス変数にハードコードされています。

この実装には、以下の問題点があります。

-   **柔軟性の欠如:** 新しい役割を持つエージェントを追加する場合、ソースコードを直接変更し、アプリケーションを再デプロイする必要があります。
-   **メンテナンス性の低下:** 役割のリストがコード内に埋もれているため、現在どのような役割が有効であるかを一覧で確認することが困難です。
-   **設定管理の一貫性欠如:** 他の多くの設定値が`config.py`や環境変数で管理されているにもかかわらず、エージェントの役割だけがコード内で管理されており、一貫性がありません。

最近、新しいエージェントが追加された際に、このハードコードが原因でタスクが自動的に割り当てられないという問題が発生しました。将来的にエージェントの種類が増減することを見据え、より柔軟でメンテナンスしやすい構成に変更する必要があります。

## ゴール / Goals
エージェントの役割定義を、ソースコードにハードコードされた状態から、外部のYAMLファイルで管理する方式に変更し、システム運用における柔軟性、メンテナンス性、設定管理の一貫性を向上させることを目標とします。これにより、新しい役割を持つエージェントの追加や変更が容易になり、タスク割り当ての自動化をより堅牢なものにします。

### 機能要件 / Functional Requirements
-   エージェントの役割定義を外部YAMLファイルから読み込めること。
-   YAMLファイルには、少なくとも`role`（文字列）と`description`（文字列）が含まれること。
-   アプリケーション起動時にYAMLファイルの内容を検証し、不正なフォーマットの場合はエラーを発生させること。
-   `TaskService`が、ハードコードされた役割リストではなく、外部から読み込まれた役割定義を動的に使用してタスク割り当てを判断すること。
-   新しいエージェント役割が追加された場合、ソースコードの変更なしにシステムが認識し、タスクを割り当てられること（検証基準1）。

### 非機能要件 / Non-Functional Requirements
-   **柔軟性:** エージェント役割の追加、変更、削除が、コード変更なしに設定ファイルのみで行えること。
-   **保守性:** 現在有効なエージェント役割が、設定ファイルを通じて容易に確認できること。
-   **一貫性:** 他の設定と同様に、エージェント役割定義も設定管理の一元化されたアプローチに従うこと。
-   **堅牢性:** 不正な設定ファイルに対しては、アプリケーションが適切にエラーを検出し、起動を中止すること（検証基準2）。

## 設計 / Design

### ハイレベル設計 / High-Level Design
エージェントの役割定義を、`github_broker/infrastructure/config.py`でパスが指定される外部YAMLファイル`agents.yml`によって管理します。アプリケーション起動時に`AgentConfigLoader`がYAMLファイルをPydanticモデルに基づいて検証し、`TaskService`はその結果をDIコンテナを通じて受け取り、動的にタスク割り当てを行います。

### 詳細設計 / Detailed Design

1.  **エージェント定義ファイル（YAML）の導入:**
    -   エージェントの定義を管理するためのYAMLファイルを新たに導入します。ファイル形式は以下の通りです。
        ```yaml
        # agents.yml
        agents:
          - role: BACKENDCODER
            description: "バックエンド開発タスクを担当..."
          - role: SYSTEM_ARCHITECT
            description: "システム全体のアーキテクチャを設計..."
        ```

2.  **設定の更新 (`config.py`):**
    -   `github_broker/infrastructure/config.py` の `Settings` クラスに、`AGENT_CONFIG_PATH: str` という新しい設定項目を追加します。
    -   この値は、環境変数 `AGENT_CONFIG_PATH` から読み込まれ、上記YAMLファイルのパスを指定します。
    -   環境変数が設定されていない場合、デフォルトのパスとして `/app/agents.yml` を使用します。

3.  **ローダー/バリデーターコンポーネントの作成:**
    -   指定されたパスからYAMLファイルを読み込み、その構造と内容を検証する新しいコンポーネント（`AgentConfigLoader`）を作成します。
    -   このローダーは、Pydanticモデルを用いて、各エージェントが `role: str` と `description: str` を持つことを保証します。
    -   ファイルが存在しない、または内容が不正な場合は、アプリケーションの起動時にエラーを発生させ、設定の誤りを即座に検知できるようにします。

4.  **`TaskService`の修正:**
    -   `TaskService`は、起動時にDIコンテナを通じて、上記ローダーによって検証されたエージェント定義のリストを受け取ります。
    -   `TaskService`内にハードコードされていた役割のリストを削除し、インジェクションされた定義リストを動的に使用して、タスク割り当ての判断を行います。

## 検討した代替案 / Alternatives Considered

-   **現状維持 (ハードコード):** 新しいエージェントの追加や変更のたびにコード修正とデプロイが必要であり、柔軟性、メンテナンス性、設定管理の一貫性において問題があるため却下。
-   **データベース管理:** エージェント役割をデータベースで管理する案も考えられるが、現状のシステム規模とエージェント役割の変更頻度を考慮すると、YAMLファイルによる管理の方がシンプルでオーバーヘッドが少ないと判断。将来的な拡張性については、YAMLファイルからの読み込み機構を保持しつつ、データベースからの読み込みに切り替えることも可能。

### メリット (Positive consequences of chosen design)

-   **柔軟性の向上:** ソースコードの変更や再デプロイを行うことなく、環境変数を変更するだけで、動的にエージェントの役割を追加、変更、削除できるようになります。
-   **メンテナンス性の向上:** `.env`ファイルやデプロイ設定を見れば、現在有効なエージェントの役割を一覧で簡単に確認できるようになります。
-   **設定の一元管理:** すべての環境依存の設定が`config.py`と環境変数に集約され、設定管理の一貫性が向上します。

### デメリット (Negative consequences of chosen design)

-   **設定の分散:** 役割定義という情報が、コードベースからインフラの設定（環境変数や`.env`ファイル）に移動します。ただし、これは`.env.sample`ファイルにデフォルト値を記述することで、開発者がどのような設定が必要かを把握しやすくすることができます。

## セキュリティとプライバシー / Security & Privacy
本設計は、エージェントの役割定義を外部ファイルに移動するものであり、機密情報を含むものではありません。したがって、特段のセキュリティおよびプライバシー上の懸念は発生しません。

## 未解決の問題 / Open Questions & Unresolved Issues
特になし。

## 検証基準 / Verification Criteria

この意思決定が正しく実装されたことは、以下の方法で確認できます。

1.  **正常系:**
    -   `agents.yml` ファイルに新しいエージェント（例: `role: NEW_AGENT`, `description: "..."`）を追加する。
    -   環境変数 `AGENT_CONFIG_PATH` にそのファイルのパスを指定してアプリケーションを起動する。
    -   GitHubリポジトリで、`NEW_AGENT` ラベルが付いた新しいIssueを作成する。
    -   システムがこのIssueをタスクとして正しく認識し、エージェントに割り当てることをログなどで確認できること。

2.  **異常系（バリデーション）:**
    -   環境変数 `AGENT_CONFIG_PATH` に存在しないファイルパスを指定して起動すると、アプリケーションがエラーを出力して起動に失敗すること。
    -   `agents.yml` ファイル内のエージェント定義から `role` キーを削除するなど、不正なフォーマットにして起動すると、アプリケーションがエラーを出力して起動に失敗すること。

## 実装状況 / Implementation Status
完了