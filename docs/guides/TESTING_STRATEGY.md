# テスト戦略ガイドライン

## 1. 全体方針

本プロジェクトでは、品質と開発速度を両立させるため、**テストピラミッド**の考え方を採用します。テストは自動化され、CI/CDパイプラインに組み込まれることを前提とします。

- **テストフレームワーク:** `pytest` を標準とします。
- **テストの分離:** 外部サービス（GitHub API, Redisなど）への依存を必要とするテスト（統合テスト）と、そうでないテスト（単体テスト）を明確に分離します。

## 2. アーキテクチャレイヤー毎のテスト

本プロジェクトはクリーンアーキテクチャを採用しており、各レイヤーの責務に応じてテストの種類を定義します。

### 2.1. Domain Layer

- **責務:** プロジェクト全体のコアとなるビジネスロジックをテストします。
- **種類:** **単体テスト**
- **実装方針:**
    - フレームワークや外部ライブラリへの依存は一切ありません。
    - 外部への依存がないため、モックは不要です。
    - オブジェクトが正しい状態を維持し、ビジネスルールを正確に実行することを確認します。

### 2.2. Application Layer

- **責務:** ユースケース（アプリケーション固有のビジネスロジック）をテストします。
- **種類:** **単体テスト**
- **実装方針:**
    - Infrastructureレイヤーのインターフェース（`GitHubClient`, `RedisClient`など）は、**すべてモック**します。
    - ユースケースが、DomainオブジェクトとInfrastructureのインターフェースを正しく協調させて、ビジネスフローを達成することを確認します。

### 2.3. Interface Layer

- **責務:** APIエンドポイントの挙動（リクエストの受け付け、レスポンスの返却）をテストします。
- **種類:** **単体テスト**
- **実装方針:**
    - FastAPIの`TestClient`を使用します。
    - Applicationレイヤーのサービス（`TaskService`など）は、**すべてモック**します。
    - 正しいリクエストに対して`200 OK`が返されること、不正なリクエストに対して適切なエラーコード（`4xx`など）が返されることを確認します。

### 2.4. Infrastructure Layer

- **責務:** 外部サービスとの連携部分をテストします。
- **種類:** **単体テスト** と **統合テスト**
- **実装方針:**
    - **単体テスト:**
        - 外部ライブラリ（例: `PyGithub`, `redis-py`）をモックし、クライアントクラスのロジック（API呼び出しのパラメータ構築など）が正しいことを検証します。
    - **統合テスト:**
        - 実際に外部サービス（GitHub API, Redis）と通信し、連携が正しく機能することを確認します。
        - これらのテストは実行に時間がかかり、外部環境に依存するため、数は最小限に留めます。

## 3. モック/スタブの方針

- Python標準の `unittest.mock` ライブラリ（`MagicMock`, `patch`）を標準のモッキングツールとして使用します。
- 原則として、テスト対象のレイヤーより外側（Infrastructure側）の依存関係はすべてモックします。

## 4. pytestマーカーの利用

テストの種類を明確に分離し、CIでの実行を制御するために、以下のマーカーを使用します。

- `@pytest.mark.unit`
    - **対象:** Domain, Application, Interfaceレイヤーのテスト、およびInfrastructureレイヤーの単体テスト。
    - **特徴:** 高速に実行でき、外部依存がありません。
- `@pytest.mark.integration`
    - **対象:** Infrastructureレイヤーの統合テスト。
    - **特徴:** 実行が遅く、外部サービス（APIキーなどの設定が必要）に依存します。

CIでは、Pull Request時には全てのテストを実行し、Push時には高速な単体テストのみを実行するなどの制御を行います。

## 5. テストの命名規則

- **ディレクトリ構造:** `tests/` ディレクトリは、ソースディレクトリ `github_broker/` の構造をミラーします。
    - 例: `github_broker/application/task_service.py` のテストは `tests/application/test_task_service.py` に配置します。
- **ファイル名:** `test_*.py` の形式で命名します。
- **関数名:** `test_*` の形式で命名し、テストする振る舞いが明確にわかるように記述します。
    - 良い例: `test_request_task_returns_none_when_no_task_available`
    - 悪い例: `test_function1`
