# テスト戦略ガイドライン

## 1. 全体方針

本プロジェクトでは、品質と開発速度を両立させるため、**テストピラミッド**の考え方を採用します。テストは自動化され、CI/CDパイプラインに組み込まれることを前提とします。

- **テストフレームワーク:** `pytest` を標準とします。
- **テストの分離:** 外部サービスへの依存有無に基づき、テストを明確に分類します。

### 1.1. テストの定義

- **単体テスト (Unit Test):**
    - **定義:** 一つのモジュールや関数など、単一のコンポーネントが仕様通りに動作することを確認するテスト。
    - **特徴:** 実行は高速で、外部依存（ファイルシステム、データベース、APIなど）を持ちません。依存するコンポーネントはモックに置き換えます。
- **統合テスト (Integration Test):**
    - **定義:** 複数のコンポーネントを連携させた際に、全体が正しく機能することを確認するテスト。
    - **特徴:** 実際に外部サービス（GitHub API, Redisなど）と通信します。実行は比較的低速で、外部環境への設定（APIキーなど）を必要とします。

## 2. アーキテクチャレイヤー毎のテスト

本プロジェクトはクリーンアーキテクチャを採用しており、各レイヤーの責務に応じてテストの種類を定義します。

### 2.1. Domain Layer

- **責務:** プロジェクト全体のコアとなるビジネスロジックをテストします。
- **種類:** **単体テスト**
- **実装方針:**
    - フレームワークや外部ライブラリへの依存は一切ありません。
    - 外部への依存がないため、モックは不要です。
    - オブジェクトが正しい状態を維持し、ビジネスルールを正確に実行することを確認します。

### 2.2. Application Layer

- **責務:** ユースケース（アプリケーション固有のビジネスロジック）をテストします。
- **種類:** **単体テスト**
- **実装方針:**
    - Infrastructureレイヤーのインターフェース（`GitHubClient`, `RedisClient`など）は、**すべてモック**します。
    - ユースケースが、DomainオブジェクトとInfrastructureのインターフェースを正しく協調させて、ビジネスフローを達成することを確認します。

### 2.3. Interface Layer

- **責務:** APIエンドポイントの挙動（リクエストの受け付け、レスポンスの返却）をテストします。
- **種類:** **単体テスト**
- **実装方針:**
    - FastAPIの`TestClient`を使用します。
    - Applicationレイヤーのサービス（`TaskService`など）は、**すべてモック**します。
    - 正しいリクエストに対して`200 OK`が返されること、不正なリクエストに対して適切なエラーコード（`4xx`など）が返されることを確認します。

### 2.4. Infrastructure Layer

- **責務:** 外部サービスとの連携部分をテストします。
- **種類:** **単体テスト** と **統合テスト**
- **実装方針:**
    - **単体テスト:**
        - 外部ライブラリ（例: `PyGithub`, `redis-py`）をモックし、クライアントクラスのロジック（API呼び出しのパラメータ構築など）が正しいことを検証します。
    - **統合テスト:**
        - 実際に外部サービス（GitHub API, Redis）と通信し、連携が正しく機能することを確認します。
        - これらのテストは実行に時間がかかり、外部環境に依存するため、数は最小限に留めます。

## 3. モック/スタブの方針

- Python標準の `unittest.mock` ライブラリ（`MagicMock`, `patch`）を標準のモッキングツールとして使用します。
- 原則として、テスト対象のレイヤーより外側（Infrastructure側）の依存関係はすべてモックします。

## 4. pytestマーカーの利用とCI戦略

テストの種類を明確に分離し、CIでの実行を制御するために、以下のマーカーを使用します。

- `@pytest.mark.unit`
    - **対象:** Domain, Application, Interfaceレイヤーのテスト、およびInfrastructureレイヤーの単体テスト。
- `@pytest.mark.integration`
    - **対象:** Infrastructureレイヤーの統合テスト。

### CIでの実行戦略

CIでは、ワークフローのトリガーに応じて実行するテストを動的に変更します。

- **Pull Request時:** すべてのテストを実行し、変更の安全性を最大限に確保します。
  ```shell
  pytest
  ```
- **mainブランチへのPush時:** 高速な単体テストのみを実行し、迅速なフィードバックを優先します。
  ```shell
  pytest -m "unit"
  ```
- **夜間バッチなど:** 定期的にすべてのテストを実行し、システムの健全性を継続的に監視します。
  ```shell
  pytest
  ```

## 5. テストの命名規則

- **ディレクトリ構造:** `tests/` ディレクトリは、ソースディレクトリ `github_broker/` の構造をミラーします。
    - 例: `github_broker/application/task_service.py` のテストは `tests/application/test_task_service.py` に配置します。
- **ファイル名:** `test_*.py` の形式で命名します。
- **関数名:** `test_*` の形式で命名し、テストする振る舞いが明確にわかるように記述します。
    - 良い例: `test_request_task_returns_none_when_no_task_available`
    - 悪い例: `test_function1`

## 6. E2E（End-to-End）テストについて

- **現状:** 現在のスコープでは、E2Eテストの導入は必須ではありません。各レイヤーの単体・統合テストで品質を担保することを主眼とします。
- **将来的な展望:** プロダクトが成長し、より複雑なユーザーシナリオを保証する必要が出てきた段階で、E2Eテストの導入を検討します。その際は、`Selenium`や`Playwright`などのフレームワークを利用し、実際のユーザー操作をシミュレートするテストを構築します。
