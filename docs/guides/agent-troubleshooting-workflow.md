# エージェントのトラブルシューティングと行動原則

このドキュメントは、AIエージェントが開発タスク、特にデバッグにおいて問題解決に行き詰まった際の行動原則を定義する。

## 背景

Issue #484の対応において、DIコンテナ`punq`の実装に関する問題で、エージェントが同じ種類の`TypeError`に対して類似した解決策を繰り返し試行し、解決に著しい遅延が生じた。これは、エージェントが自身の初期仮説に固執し、思考のループに陥ったことが原因である。この事態は、ユーザーによる具体的な指示があるまで解決されなかった。

この失敗から学び、同様の問題の再発を防止するため、以下の行動原則を導入する。

## 行動原則

### 1. 「三振」ルール (The "Three Strikes" Rule)

**原則:** 同一の根本原因（例: 同じエラーメッセージ）に対して、同じ基本的なアプローチに基づいた修正が**2回**連続で失敗した場合、そのアプローチは根本的に間違っている可能性が極めて高いと判断する。3回目の試行（三振）を行う前に、ただちに次の「仮説の転換」フェーズに移行しなければならない。

**例:** `punq`のファクトリに関する`TypeError`に対し、「ファクトリ関数の記述を少し変える」というアプローチを2回試して失敗した場合、3回目も同じことを試みてはならない。

### 2. 仮説の転換 (Hypothesis Pivot)

**原則:** 「三振」ルールが適用された場合、それまでの仮説を一旦完全に破棄し、問題の発生源について、全く異なるカテゴリの仮説を立てる。

仮説のカテゴリには、例えば以下のようなものがある。
- **レイヤー1: コード実装の問題:** 「自分のコードのロジックが間違っているのではないか？」
- **レイヤー2: ライブラリ仕様の誤解:** 「自分が使っているライブラリ（`punq`）の仕様を、そもそも誤解しているのではないか？」
- **レイヤー3: ライブラリ間の競合:** 「複数のライブラリ（`punq`と`pydantic`）が、予期せぬ相互作用を起こしているのではないか？」
- **レイヤー4: 実行コンテキストの問題:** 「テストの実行順序や、環境変数、パッチの適用タイミングなど、コードの外側に問題があるのではないか？」

**行動:** 失敗したアプローチがどのレイヤーに属するかを自己分析し、次は必ず**別のレイヤー**の仮説を立てて検証する。

### 3. 明示的な自己対話と報告

**原則:** 新しい仮説に基づいて行動を起こす前に、その仮説をユーザーに対して明示的に宣言する。これにより、思考プロセスが透明化され、ユーザーからの早期の軌道修正が可能になる。

**悪い例:** （黙って何度もコードを修正する）

**良い例:** 
> 「`punq`のファクトリに関する`TypeError`が解決できません。これまでの試行は『ファクトリ関数の記述方法が少し違う』という仮説に基づいていましたが、すべて失敗しました。これは、**『`punq`はファクトリの引数を自動解決しない』という仕様を私が誤解している**可能性が高いことを示唆しています。この新しい仮説に基づき、次は依存関係を手動で構築するアプローチを試します。」

この原則に従うことで、エージェントは単一の解決策に固執することを避け、より体系的かつ効率的な問題解決を実行できるようになる。そして、人間の監督者との連携を強化し、致命的な時間の浪費を防ぐ。
