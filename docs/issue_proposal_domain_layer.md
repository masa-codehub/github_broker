---
title: 'Refactor: ビジネスロジックをDomain層へ分離'
labels: 'refactoring, architecture'
---

## 概要

現在の`TaskService` (`application`層) には、Issueの準備状態を判断するロジックや、ブランチ名を決定するロジックなど、ドメイン固有のビジネスルールが直接実装されています。クリーンアーキテクチャの原則に従い、これらのコアなビジネスロジックを`domain`層へ分離し、アプリケーション層の責務をより明確にします。

## あるべき姿

- `domain`層に、タスク（Issue）の状態や振る舞いを管理する`Task`エンティティ（またはそれに類するドメインオブジェクト）が定義されている。
- Issueがタスクとして割り当て可能かどうかを判断するビジネスルール（例: `is_ready_for_assignment()`）は、`Task`エンティティ内にカプセル化されている。
- デフォルトのブランチ名を生成するロジックも、ドメイン層の責務として実装されている。
- `application`層の`TaskService`は、これらのドメインオブジェクトを利用してユースケースを実現する役割に専念し、ドメインルールそのものを知らなくてもよい状態になっている。

## タスク

1.  `Task`エンティティ（またはドメインモデル）を`github_broker/domain/`以下に新規作成する。
2.  `TaskService`から、Issueの準備状態をチェックするロジック (`_is_task_ready`) を`Task`エンティティへ移動する。
3.  `TaskService`から、ブランチ名を決定するロジック (`_parse_issue_body`の一部) を`Task`エンティティまたは関連するドメインサービスへ移動する。
4.  `TaskService`が新しいドメインオブジェクトを利用するようリファクタリングする。
5.  上記変更に伴うユニットテストを修正・追加する。

## 期待される効果

- ビジネスルールの凝集性が高まり、コードの見通しが良くなる。
- `application`層が特定のフレームワークやライブラリから独立し、テスト容易性が向上する。
- 将来的な仕様変更（例: 割り当て条件の追加）が`domain`層の変更に限定され、影響範囲を特定しやすくなる。
