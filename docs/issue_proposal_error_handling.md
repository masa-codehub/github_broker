---
title: 'Refactor: カスタム例外クラスを導入しエラーハンドリングを改善'
labels: 'refactoring, enhancement'
---

## 概要

現在、`TaskService`内でロック取得に失敗した場合などに汎用的な`Exception`が送出され、API層で一括して`HTTP 503`として処理されています。この実装では、将来的に他の種類のエラーが発生した場合に、原因を特定し、クライアントへ適切なフィードバックを返すことが困難になります。

アプリケーション固有のカスタム例外クラスを定義し、エラーの種類に応じたきめ細やかなハンドリングを実現します。

## あるべき姿

- `domain`または`application`層に、ビジネスロジック上のエラーを示すカスタム例外クラスが定義されている（例: `LockAcquisitionError`, `NoTaskAvailableError`）。
- `TaskService`は、特定の状況に応じてこれらのカスタム例外を送出する。
- `interface/api.py`のFastAPIエラーハンドラが、これらのカスタム例外を捕捉し、それぞれに対応したHTTPステータスコードとエラーメッセージをクライアントに返却する。
- クライアントは、エラーレスポンスに基づき、リトライすべきか、処理を中断すべきかを判断できる。

## タスク

1.  `github_broker/application/exceptions.py`のようなファイルを作成し、カスタム例外クラス（例: `LockAcquisitionError`）を定義する。
2.  `TaskService`の`request_task`メソッドを修正し、ロック取得失敗時に`Exception`の代わりに`LockAcquisitionError`を送出するよう変更する。
3.  FastAPIにカスタム例外ハンドラを追加し、`LockAcquisitionError`を捕捉して`HTTP 503`を返すように実装する。
4.  将来的な拡張性を考慮し、他のエラーケース（例: 適切なタスクが見つからない場合）についてもカスタム例外を導入することを検討する。
5.  例外処理の変更に対応するユニットテストを修正・追加する。

## 期待される効果

- エラーの原因が明確になり、デバッグやトラブルシューティングが容易になる。
- APIの利用者がエラーの種類を判別しやすくなり、より堅牢なクライアント実装を促す。
- アプリケーションのロバスト性（堅牢性）が向上する。
