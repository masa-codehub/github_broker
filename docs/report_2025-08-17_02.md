# 2025-08-17 作業記録: Agent安定化に向けたデバッグと改善

## 1. 概要

本ドキュメントは、エージェントがタスクを実行できない一連の問題について、その原因調査、修正、および再発防止策の導入に至るまでの経緯を記録したものである。

## 2. 問題の経緯と解決策

### 2.1. 初期症状: 503 Service Unavailable

- **問題**: `sample_agent.py` を実行すると、サーバーから `503 Service Unavailable` が返され、タスクを取得できなかった。
- **調査**: 当初はRedisのロック競合が疑われたが、ロックを解放しても問題は解決しなかった。
- **原因**: `api.py` に詳細なエラーログを記録するよう修正した結果、`task_service.py` 内で正規表現パターン `BRANCH_PATTERN` が未定義であることによる `NameError` が根本原因であると判明した。
- **解決策**: `task_service.py` に `BRANCH_PATTERN` と `DELIVERABLES_PATTERN` の定義を追加した。

### 2.2. 仕様不一致①: Issueテンプレートの解析失敗

- **問題**: `NameError` 解決後も、エージェントは「タスクがない」と判断した。
- **原因**: `.gemini/issue_template.md` を確認したところ、Issue本文の見出しが英語 (`### Deliverables`) ではなく、日本語 (`## 成果物`) で定義されていることが判明。実装した正規表現が仕様と異なっていた。
- **解決策**: 正規表現パターンを日本語の見出しに一致するように修正した。

### 2.3. 仕様不一致②: コンポーネントの乖離

- **問題**: 正規表現の修正後、`AttributeError: 'GeminiExecutor' object has no attribute 'select_best_issue'` という新たなエラーが発生した。
- **原因**: `GeminiExecutor` のドキュメントと実際の実装が完全に異なっていることが判明。`TaskService` はドキュメント（古い仕様）に基づいてIssue選択を `GeminiExecutor` に依頼しようとしていたが、実際の実装にその機能は存在しなかった。
- **解決策**: ユーザーと協議の上、暫定対応としてAIによるIssue選択機能を無効化。`TaskService` が、準備完了のIssueリストから最初の1件を機械的に選択するロジックに修正した。

### 2.4. 実行時エラー: 相対パスの使用

- **問題**: `gemini` コマンド（AIエージェント）が `write_file` ツールに相対パスを渡してしまい、ツール側でエラーが発生し異常終了していた。
- **原因**: エージェントの行動規範に、絶対パスを使用する明確な指示がなかった。
- **解決策**: ユーザーの提案に基づき、`gemini_executor.py` のプロンプトを直接変更するのではなく、より汎用的な `.gemini/GEMINI.md` の「制約条件」に、ファイル操作では必ず絶対パスを使用するルールを明記した。

### 2.5. プロセス不履行: コミット漏れ

- **問題**: エージェントがタスク完了を報告したものの、プルリクエストの作成に失敗していた。
- **原因**: ログを分析した結果、エージェントがコード変更を `git commit` せずにプルリクエストを作成しようとしていたことが判明。差分がないため、GitHub APIがエラーを返していた。
- **解決策**: ユーザーと協議し、「トランザクショナル・プルリクエスト」という概念を定義。`git status` による検証を各ステップに挟んだ、`git status` → `git add` → `git status` → `git commit` → `git log` → `git push` → `create_pull_request` という厳密なシーケンスを `.gemini/GEMINI.md` の「制約条件」に追記し、エージェントがこのプロセスを遵守するように指示した。

## 3. 結論

一連のデバッグを通じて、複数の根深い問題が明らかになった。これに対し、その場しのぎの修正ではなく、エージェントの行動規範そのものである `.gemini/GEMINI.md` を改善することで、より堅牢で信頼性の高い動作を促すというアプローチを取った。これにより、同様の問題の再発が抑制されることが期待される。
