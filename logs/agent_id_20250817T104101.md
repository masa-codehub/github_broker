[ERROR] [IDEClient] Failed to connect to IDE companion extension for VS Code. Please ensure the extension is running and try restarting your terminal. To install the extension, run /ide install.
Loaded cached credentials.
はい、承知いたしました。GitHub Issue #45 の解決に取り組みます。

まず、作業ブランチ `refactor/issue-45-custom-exception-handling` に切り替えます。ブランチは既にチェックアウト済みでしたので、Issueの指示に従い、実装を開始します。

**OODAループ: 1. Observe (観察・分析)**

まず、Issueで指摘されている関連ファイルを読み込み、現状のコードベースを把握します。
- `github_broker/application/task_service.py`
- `github_broker/interface/api.py`
- `tests/application/test_task_service.py`def test_request_task_fails_on_issue_selection_after_gemini(task_service_components):
    """Test that an exception during issue selection after Gemini is handled."""
    task_service, mock_github_client, mock_redis_client, mock_gemini_client, _ = task_service_components
    mock_redis_client.acquire_lock.return_value = True
    mock_github_client.find_issues_by_labels.return_value = None

    mock_issue = MagicMock()
    mock_issue.number = 123
    mock_issue.body = VALID_ISSUE_BODY
    mock_github_client.get_open_issues.return_value = [mock_issue]
    mock_gemini_client.select_best_issue_id.return_value = mock_issue.number

    # Simulate the issue being deleted *after* Gemini selects it
    mock_github_client.get_issue.side_effect = UnknownObjectException(status=404, data={}, headers={})

    result = task_service.request_task("any-agent", [])

    assert result is None
    mock_redis_client.release_lock.assert_called_once()
    mock_github_client.get_issue.assert_called_once_with(mock_issue.number)
**2. Orient (方針決定・計画)**

観察・分析の結果に基づき、以下の計画を立てます。

1.  **カスタム例外の作成**:
    -   `github_broker/application/exceptions.py` を新規作成します。
    -   `LockAcquisitionError` クラスを定義します。これはPythonの標準 `Exception` クラスを継承します。

2.  **`TaskService` の修正**:
    -   `github_broker/application/task_service.py` を修正します。
    -   ロック取得失敗時に `Exception` を送出している箇所を、新しい `LockAcquisitionError` を送出するように変更します。
    -   ファイルの先頭で `from ..application.exceptions import LockAcquisitionError` をインポートします。

3.  **APIエラーハンドラの修正**:
    -   `github_broker/interface/api.py` を修正します。
    -   既存の汎用的な `except Exception` ブロックの前に、`except LockAcquisitionError` ブロックを追加します。
    -   この新しいブロックで `LockAcquisitionError` を捕捉し、HTTP 503エラーと詳細メッセージを返します。
    -   `from ..application.exceptions import LockAcquisitionError` をインポートします。

4.  **ユニットテストの修正**:
    -   `tests/application/test_task_service.py` を修正します。
    -   ロック取得失敗をテストする `test_request_task_lock_fails` ケースを修正します。
    -   `pytest.raises` が `Exception` の代わりに `LockAcquisitionError` を期待するように変更します。
    -   テストファイルの先頭で `from github_broker.application.exceptions import LockAcquisitionError` をインポートします。

**3. Decide (意思決定)**

計画に基づき、まず `github_broker/application/exceptions.py` を作成することから始めます。

**4. Act (実行)**

カスタム例外クラスを定義した新しいファイルを作成します。Error executing tool write_file: File path must be absolute: github_broker/application/exceptions.py
