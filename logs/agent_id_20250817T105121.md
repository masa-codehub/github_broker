[ERROR] [IDEClient] Failed to connect to IDE companion extension for VS Code. Please ensure the extension is running and try restarting your terminal. To install the extension, run /ide install.
Loaded cached credentials.
はい、承知いたしました。GitHub Issueの解決に取り組みます。
まず、作業ブランチ `refactor/issue-45-custom-exception-handling` に切り替えます。ブランチは既に存在し、切り替え済みです。
では、Issueの指示に従い、実装を開始します。

まず、現状を把握するために関連ファイルを読み込みます。ファイルの内容を確認しました。現状は以下のようになっています。

- **`TaskService`**: `request_task`メソッドの冒頭で`redis_client.acquire_lock()`を呼び出し、失敗した場合は汎用的な`Exception`を送出しています。
- **`api.py`**: FastAPIのルートハンドラが、`TaskService`から送出された`LockAcquisitionError`と汎用的な`Exception`を捕捉し、`HTTP 503`を返しています。しかし、エラーの種類を区別できていません。
- **`test_task_service.py`**: `test_request_task_lock_fails`というテストケースで、ロック失敗時に`Exception`が送出されることを確認しています。

これをIssueの要件に従ってリファクタリングします。

**2. Orient (方針決定・計画)**

1.  **`github_broker/application/exceptions.py`を作成**: `LockAcquisitionError`というカスタム例外クラスを定義します。
2.  **`TaskService`を修正**: ロック取得失敗時に、汎用の`Exception`の代わりに`LockAcquisitionError`を送出するように変更します。
3.  **`api.py`を修正**: `LockAcquisitionError`を捕捉する専用の例外ハンドラを追加し、汎用の`Exception`ハンドラは削除します。これにより、意図したエラーのみを捕捉するようになります。
4.  **`test_task_service.py`を修正**: `test_request_task_lock_fails`テストが、`Exception`の代わりに`LockAcquisitionError`を期待するように修正します。

**3. Decide (意思決定)**

計画に基づき、まず`github_broker/application/exceptions.py`を作成することから始めます。

**4. Act (実行)**

`exceptions.py`ファイルを作成し、`LockAcquisitionError`クラスを定義します。`exceptions.py`を作成しました。
次に、`task_service.py`を修正し、汎用の`Exception`の代わりに、先ほど作成した`LockAcquisitionError`を送出するように変更します。

まず、最新のファイル内容を読み込みます。ファイルの内容を再確認しました。
`task_service.py`の`request_task`メソッドを修正し、ロック取得失敗時に`LockAcquisitionError`を送出するようにします。Error executing tool replace: Error: Failed to edit, could not find the string to replace.
`replace`に失敗しました。`old_string`がファイルの内容と完全に一致しなかったようです。
再度ファイル内容を正確に読み込み、より多くのコンテキストを含めて`replace`を再試行します。なるほど、`task_service.py`はすでに修正済みでした。どうやら以前の試行が成功していたようです。

では、次のステップに進みます。
**`api.py`を修正し、`LockAcquisitionError`に対する専用の例外ハンドラを整備します。**

まず、`api.py`の現状を確認します。`api.py`を確認しました。現在は`try...except`ブロックで例外を処理していますが、FastAPIの作法に則り、`@app.exception_handler`デコレータを使った、より堅牢なエラーハンドリングにリファクタリングします。

具体的には、以下の通りです。
1.  `LockAcquisitionError`を捕捉する専用の例外ハンドラ関数を定義します。
2.  `@app.exception_handler(LockAcquisitionError)`デコレータで、その関数をアプリケーションに登録します。
3.  `request_task`エンドポイントから既存の`try...except`ブロックを削除し、`task_service`の呼び出しを直接行います。

この変更により、エラー処理の関心が分離され、コードがクリーンになります。
では、`replace`ツールを使ってファイルを一括で更新します。`api.py`の例外処理を更新しました。
次に関連する`Request`と`JSONResponse`を`fastapi`からインポートする必要があります。
ファイルを再度読み込み、必要なインポート文を追加します。`replace`コマンドでインポート文がファイルの中間に追加されてしまいました。これをファイルの先頭に移動させます。
ファイルを読み込み、`replace`を使ってインポート文を修正します。インポート文を修正しました。次に、ファイルの途中に追加された重複したインポート文を削除します。`api.py`のインポート文を整理しました。

最後のステップとして、テストを更新します。

**実行（Act） - ステップ4： `test_task_service.py`の修正**

`tests/application/test_task_service.py` を修正し、汎用的な `Exception` の代わりに `LockAcquisitionError` をチェックするようにします。

まず、ファイルを読み込みます。Error executing tool read_file: File path must be absolute, but was relative: tests/application/test_task_service.py. You must provide an absolute path.
